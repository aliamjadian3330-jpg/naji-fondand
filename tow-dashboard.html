<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>پنل یدک‌کش حرفه‌ای</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:sans-serif;}
body,html{height:100%;width:100%;background:#f0f2f5;}
#map{height:100vh;width:100%;}
#slidePanel{
  position:absolute;top:0;left:-300px;width:280px;height:100%;
  background:#3b82f6;color:white;padding:15px;transition:left 0.3s;z-index:1000;
  overflow:auto;border-top-right-radius:12px;border-bottom-right-radius:12px;
}
#slidePanel.open{left:0;}
#slidePanel h2{text-align:center;margin-bottom:10px;}
#slidePanel input, #slidePanel button{width:100%;margin-bottom:10px;padding:10px;border-radius:6px;border:none;}
#toggleBtn{
  position:absolute;top:15px;left:15px;width:50px;height:50px;border-radius:50%;
  background:#3b82f6;color:white;font-size:24px;cursor:pointer;z-index:1001;
  display:flex;justify-content:center;align-items:center;box-shadow:0 2px 6px rgba(0,0,0,0.3);
}
#driverRequestPanel{
  display:none;position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid #ccc;padding:10px;z-index:2000;
}
#driverRequestPanel p{margin:5px 0;}
</style>
</head>
<body>

<div id="map"></div>
<button id="toggleBtn" onclick="togglePanel()">☰</button>

<div id="slidePanel">
  <h2>پنل یدک‌کش</h2>

  <input type="text" id="towName" placeholder="نام یدک‌کش">
  <input type="text" id="towPhone" placeholder="شماره تماس">
  <input type="text" id="towPlate" placeholder="پلاک خودرو">
  <input type="file" id="towPhoto" onchange="previewPhoto(event)">
  <img id="photoPreview" src="https://via.placeholder.com/100" style="width:100px;height:100px;border-radius:50%;display:block;margin:auto;">

  <button onclick="registerTow()">ثبت اطلاعات</button>
  <button onclick="setCurrentLocation()">موقعیت من</button>
</div>

<div id="driverRequestPanel">
  <h3>درخواست راننده</h3>
  <p id="driverName"></p>
  <p id="driverPhone"></p>
  <p id="driverPlate"></p>
  <button onclick="acceptRequest()">قبول</button>
  <button onclick="rejectRequest()">رد</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const map = L.map('map').setView([35.6895,51.3890],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);

let slidePanel = document.getElementById('slidePanel');
function togglePanel(){ slidePanel.classList.toggle('open'); }

let towMarker=null;
let towInfo=null;
let currentRequest=null;
let towRouteLine=null;
let driverMarker=null;

const socket = io("http://localhost:5000");

// ثبت نام و ارسال اطلاعات یدک‌کش
function previewPhoto(event){
  const reader=new FileReader();
  reader.onload=function(){ document.getElementById('photoPreview').src=reader.result; }
  reader.readAsDataURL(event.target.files[0]);
}

function registerTow(){
  towInfo = {
    fullName: document.getElementById('towName').value,
    phone: document.getElementById('towPhone').value,
    plate: document.getElementById('towPlate').value,
    image: document.getElementById('photoPreview').src
  };
  socket.emit("registerTow", towInfo);
  alert("اطلاعات ثبت شد ✅");
}

// موقعیت زنده یدک‌کش
function setCurrentLocation(){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const latlng=[pos.coords.latitude,pos.coords.longitude];
      if(towMarker){ towMarker.setLatLng(latlng); } 
      else{ towMarker=L.marker(latlng).addTo(map).bindPopup("موقعیت یدک‌کش").openPopup(); }
      map.setView(latlng,14);
      // ارسال به سرور
      socket.emit('updateTowLocation',{ lat: latlng[0], lng: latlng[1] });
    });
  } else alert("موقعیت یدک‌کش فعال نیست!");
}

// دریافت درخواست راننده
socket.on('receiveRequest', data=>{
  currentRequest = data;
  document.getElementById('driverName').innerText = "نام راننده: "+data.driverInfo.fullName;
  document.getElementById('driverPhone').innerText = "تلفن: "+data.driverInfo.phone;
  document.getElementById('driverPlate').innerText = "پلاک: "+data.driverInfo.plate;
  document.getElementById('driverRequestPanel').style.display="block";

  // مارکر راننده روی نقشه
  if(driverMarker) map.removeLayer(driverMarker);
  driverMarker=L.marker([data.origin.lat,data.origin.lng],{
    icon:L.icon({ iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize:[30,30] })
  }).addTo(map).bindPopup("راننده").openPopup();

  // رسم مسیر یدک‌کش -> راننده
  if(towMarker) drawRoute(towMarker.getLatLng(),driverMarker.getLatLng());
});

// قبول یا رد درخواست
function acceptRequest(){
  if(!currentRequest) return;
  socket.emit('requestUpdate',{ requestId: currentRequest.requestId, status:'accepted', towInfo });
  document.getElementById('driverRequestPanel').style.display="none";
}

function rejectRequest(){
  if(!currentRequest) return;
  socket.emit('requestUpdate',{ requestId: currentRequest.requestId, status:'rejected' });
  document.getElementById('driverRequestPanel').style.display="none";
}

// رسم مسیر روی نقشه
async function drawRoute(start,end){
  try{
    const url=`https://router.project-osrm.org/route/v1/driving/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson`;
    const res = await fetch(url);
    const data = await res.json();
    if(data.routes && data.routes.length>0){
      const coords = data.routes[0].geometry.coordinates.map(c=>[c[1],c[0]]);
      if(towRouteLine) map.removeLayer(towRouteLine);
      towRouteLine = L.polyline(coords,{color:'red',weight:4}).addTo(map);
      map.fitBounds(towRouteLine.getBounds());
    }
  } catch(e){ console.error(e); }
}

// موقعیت زنده راننده
socket.on('updateDriverLocation', data=>{
  if(driverMarker){
    driverMarker.setLatLng([data.lat,data.lng]);
    // بروزرسانی مسیر
    if(towMarker) drawRoute(towMarker.getLatLng(),driverMarker.getLatLng());
  }
});
</script>
</body>
</html>
