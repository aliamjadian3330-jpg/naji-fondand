<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Ù¾Ù†Ù„ ÙŠØ¯Ú©â€ŒÚ©Ø´ â€” Ù†Ù‚Ø´Ù‡ Ùˆ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
/* Ù¾Ø§ÛŒÙ‡ Ùˆ Ø¨Ø¯Ù†Ù‡ */
* {margin:0; padding:0; box-sizing:border-box; font-family:"Tahoma",sans-serif;}
html, body {height:100%; width:100%; background:#f0f2f5;}

/* Ú©Ø§Ù†ØªÛŒÙ†Ø± Ù†Ù‚Ø´Ù‡ */
#mapContainer {height:100vh; width:100%; position:relative;}
#map {height:100%; width:100%; border:4px solid #2563eb; border-radius:10px; box-shadow:0 4px 20px rgba(0,0,0,0.1);}

/* Ù¾Ù†Ù„ Ú©Ø´ÙˆÛŒÛŒ Ø±Ø§Ø³Øª */
#slidePanel{
  position:absolute; top:0; right:-320px; width:300px; height:100%;
  background:#2563eb; color:#fff; padding:20px; transition:right 0.35s ease;
  z-index:1200; overflow-y:auto; border-top-left-radius:12px; border-bottom-left-radius:12px;
  box-shadow:-6px 0 20px rgba(0,0,0,0.15);
}
#slidePanel.open{right:0}

/* Ø¹Ù†Ø§ÙˆÛŒÙ† Ù¾Ù†Ù„ */
#slidePanel h2 {text-align:center; margin-bottom:15px; font-size:1.3rem; letter-spacing:0.5px;}
#slidePanel h3 {margin-bottom:8px; font-size:1rem;}

/* ÙØ±Ù…â€ŒÙ‡Ø§ Ùˆ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ */
#slidePanel input, #slidePanel select, #slidePanel button {
  width:100%; padding:10px; margin-top:10px; border-radius:8px; border:none;
  background: rgba(255,255,255,0.1); color:#fff; outline:none; font-size:0.95rem;
  transition: all 0.2s ease;
}
#slidePanel input:focus, #slidePanel select:focus {background: rgba(255,255,255,0.2);}

/* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
#slidePanel button{
  cursor:pointer; font-weight:600; box-shadow:0 3px 10px rgba(0,0,0,0.15);
}
#slidePanel button:hover {transform: translateY(-2px); opacity:0.95;}
.btn-success {background:#16a34a; color:#fff;}
.btn-success:hover {background:#15803d;}
.btn-danger {background:#ef4444; color:#fff;}
.btn-danger:hover {background:#dc2626;}
.btn-primary {background:#f59e0b; color:#fff;}
.btn-primary:hover {background:#fbbf24;}
.btn-secondary {background:#2563eb; color:#fff;}
.btn-secondary:hover {background:#3b82f6;}

/* Ø¹Ú©Ø³ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ */
#photoPreview {
  width:100px; height:100px; border-radius:50%; object-fit:cover;
  display:block; margin:10px auto; border:2px solid rgba(255,255,255,0.6);
  box-shadow:0 2px 8px rgba(0,0,0,0.2);
}

/* Toggle Button */
#toggleBtn {
  position:absolute; top:15px; right:15px; z-index:1300;
  width:50px; height:50px; border-radius:50%; border:none; cursor:pointer;
  background:#2563eb; color:#fff; font-size:24px;
  display:flex; align-items:center; justify-content:center;
  box-shadow:0 6px 18px rgba(0,0,0,0.18);
  transition: transform 0.2s ease, background 0.2s ease;
}
#toggleBtn:hover {transform: scale(1.1); background:#3b82f6;}

/* Ù¾Ù†Ù„ Ù¾Ø§ÛŒÛŒÙ†: Ù†Ù…Ø§ÛŒØ´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø§Ù†Ù†Ø¯Ù‡ */
#driverRequestPanel{
  display:none; position:fixed; left:12px; right:12px; bottom:12px; max-width:900px;
  margin:auto; background:#ffffff; color:#111; border-radius:12px; padding:16px;
  z-index:1400; box-shadow:0 8px 30px rgba(0,0,0,0.18); transition: all 0.3s ease;
}
#driverRequestPanel .row {display:flex; gap:12px; align-items:center;}
#driverRequestPanel img {width:64px; height:64px; border-radius:10px; object-fit:cover; border:1px solid #eee;}

/* Ù¾Ù†Ù„ Ù…Ø§Ù…ÙˆØ±ÛŒØª Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù… */
#towTripPanel{
  display:none; position:fixed; left:12px; right:12px; bottom:12px; max-width:900px;
  margin:auto; background:#fffbe6; color:#111; border-radius:12px; padding:16px;
  z-index:1400; box-shadow:0 8px 30px rgba(0,0,0,0.12); transition: all 0.3s ease;
}
#towTripPanel .actions{display:flex; gap:10px; margin-top:12px;}

/* Ú¯Ø±ÙˆÙ‡ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
.button-group button{margin-bottom:8px;}

/* ÙˆØ§Ú©Ù†Ø´â€ŒÚ¯Ø±Ø§ÛŒÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ */
@media(max-width:768px){
  #slidePanel {width:260px; right:-280px; padding:16px;}
  #toggleBtn {width:48px; height:48px; font-size:22px;}
  #slidePanel input,#slidePanel select,#slidePanel button{font-size:0.9rem;}
  #photoPreview {width:80px; height:80px;}
}

</style>
</head>
<body>

<div id="mapContainer">
  <div id="map"></div>

  <button id="toggleBtn" onclick="togglePanel()">ØŸ</button>
<div id="slidePanel" aria-hidden="true">
  <h2>Ù¾Ù†Ù„ ÙŠØ¯Ú©â€ŒÚ©Ø´</h2>

  <input id="towName" type="text" placeholder="Ù†Ø§Ù… ÙŠØ¯Ú©â€ŒÚ©Ø´ (Ø§Ø¬Ø¨Ø§Ø±ÛŒ)" />
  <input id="towModel" type="text" placeholder="Ù…Ø¯Ù„ Ø®ÙˆØ¯Ø±Ùˆ" />
  <input id="towPhone" type="text" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³" />
  <input id="towPlate" type="text" placeholder="Ù¾Ù„Ø§Ú© Ø®ÙˆØ¯Ø±Ùˆ" />

  <select id="towCity">
    <option value="bandar">Ø¨Ù†Ø¯Ø± Ø§Ù…Ø§Ù… Ø®Ù…ÙŠÙ†ÙŠ</option>
  </select>


  <button class="btn-success" onclick="saveTow()">Ø«Ø¨Øª ÙŠØ¯Ú©â€ŒÚ©Ø´ </button>
  <button class="btn-secondary" onclick="simulateReceive()">Ø´Ø¨ÙŠÙ‡â€ŒØ³Ø§Ø²ÙŠ Ø¯Ø±ÙŠØ§ÙØª Ø¯Ø±Ø®ÙˆØ§Ø³Øª</button>
  <button onclick="setCurrentLocation()">Ù…ÙˆÙ‚Ø¹ÙŠØª Ù…Ù†</button>

  <div style="margin-top:12px; background:#fff; color:#111; padding:10px; border-radius:8px;">
    <strong>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø³ÙŠØ±:</strong>
    <p id="towDistance">ÙØ§ØµÙ„Ù‡: -</p>
    <p id="towDuration">Ø²Ù…Ø§Ù† ØªÙ‚Ø±ÙŠØ¨ÛŒ: -</p>
  </div>
</div>

<!-- Ù¾Ù†Ù„ Ù¾Ø§ÛŒÛŒÙ†: Ù†Ù…Ø§ÛŒØ´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø§Ù†Ù†Ø¯Ù‡ -->
<div id="driverRequestPanel" role="dialog" aria-modal="true">
  <div class="request-header">
    <h3>ğŸš˜ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¬Ø¯ÛŒØ¯</h3>
  </div>
  <div class="request-body">
    
    <div class="driver-info">
      <p id="driverName"><strong>Ù†Ø§Ù…:</strong> -</p>
      <p id="driverPhone"><strong>ØªÙ„ÙÙ†:</strong> -</p>
      <p id="driverCoords"><strong>Ù…Ø¨Ø¯Ø§:</strong> -</p>
      <p id="driverDest"><strong>Ù…Ù‚ØµØ¯:</strong> -</p>
    </div>
  </div>
  <div class="request-actions">
    <button id="btnRejectRequest" class="btn btn-danger">âŒ Ø±Ø¯</button>
    <button id="btnAcceptRequest" class="btn btn-success">âœ” Ù‚Ø¨ÙˆÙ„</button>
  </div>
</div>
<style>
  #driverRequestPanel {
  display: none; /* Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ù…Ø®ÙÛŒ */
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: #fff;
  border-top-left-radius: 20px;
  border-top-right-radius: 20px;
  box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
  padding: 20px;
  font-family: "Vazirmatn", sans-serif;
  z-index: 2000;
  animation: slideUp 0.4s ease;
}

@keyframes slideUp {
  from { transform: translateY(100%); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.request-header {
  text-align: center;
  margin-bottom: 15px;
}

.request-header h3 {
  margin: 0;
  font-size: 1.2rem;
  color: #2563eb;
}

.request-body {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 10px 0;
}

.request-body img {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid #2563eb;
}

.driver-info p {
  margin: 4px 0;
  font-size: 0.95rem;
  color: #333;
}

.request-actions {
  display: flex;
  justify-content: space-between;
  margin-top: 15px;
  gap: 10px;
}

.btn {
  flex: 1;
  padding: 12px;
  border: none;
  border-radius: 12px;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-success {
  background: #10b981;
  color: #fff;
}

.btn-success:hover {
  background: #059669;
}

.btn-danger {
  background: #ef4444;
  color: #fff;
}

.btn-danger:hover {
  background: #dc2626;
}

</style>

<!-- Ù¾Ù†Ù„ Ù…Ø§Ù…ÙˆØ±ÙŠØª Ø¨Ø±Ø§ÙŠ ÙŠØ¯Ú©â€ŒÚ©Ø´ (Ù¾Ø³ Ø§Ø² Ù‚Ø¨ÙˆÙ„) -->
<!-- Ù¾Ù†Ù„ Ù…Ø£Ù…ÙˆØ±ÛŒØª ÛŒØ¯Ú©â€ŒÚ©Ø´ -->
<div id="towTripPanel" role="status">
  <div class="trip-header">
    <h3>ğŸšš Ù…Ø£Ù…ÙˆØ±ÛŒØª Ø¬Ø§Ø±ÛŒ</h3>
  </div>
  <div class="trip-body">
    <div class="trip-info">
      <p id="tripDriverName"><strong>Ù†Ø§Ù…:</strong> -</p>
      <p id="tripDriverPhone"><strong>ØªÙ„ÙÙ†:</strong> -</p>
      <p id="tripDriverPlate"><strong>Ù¾Ù„Ø§Ú©:</strong> -</p>
    </div>
    <div class="trip-actions">
      <button id="btnTowEnd" class="btn btn-success">âœ” Ù¾Ø§ÛŒØ§Ù† Ù…Ø£Ù…ÙˆØ±ÛŒØª</button>
      <button id="btnTowCancel" class="btn btn-danger">âŒ Ù„ØºÙˆ Ù…Ø£Ù…ÙˆØ±ÛŒØª</button>
    </div>
  </div>
</div>
<style>
  #towTripPanel {
  display: none; /* Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ù…Ø®ÙÛŒ */
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: #fff;
  border-top-left-radius: 20px;
  border-top-right-radius: 20px;
  box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
  padding: 20px;
  font-family: "Vazirmatn", sans-serif;
  z-index: 2000;
  animation: slideUp 0.4s ease;
}

@keyframes slideUp {
  from { transform: translateY(100%); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.trip-header {
  text-align: center;
  margin-bottom: 15px;
}

.trip-header h3 {
  margin: 0;
  font-size: 1.2rem;
  color: #2563eb;
}

.trip-body {
  display: flex;
  align-items: center;
  gap: 15px;
}

.trip-body img {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid #2563eb;
}

.trip-info p {
  margin: 4px 0;
  font-size: 0.95rem;
  color: #333;
}

.trip-actions {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.btn {
  padding: 10px 14px;
  border: none;
  border-radius: 12px;
  font-size: 0.95rem;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-success {
  background: #10b981;
  color: #fff;
}

.btn-success:hover {
  background: #059669;
}

.btn-danger {
  background: #ef4444;
  color: #fff;
}

.btn-danger:hover {
  background: #dc2626;
}

/* ÙˆØ§Ú©Ù†Ø´Ú¯Ø±Ø§ÛŒÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ */
@media (max-width: 768px){
  .trip-body {
    flex-direction: column;
    align-items: flex-start;
  }
  .trip-actions {
    flex-direction: row;
    width: 100%;
  }
  .trip-actions .btn {
    flex: 1;
  }
}

</style>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  function previewPhoto(event){
  const reader = new FileReader();
  reader.onload = function(){
    document.getElementById('photoPreview').src = reader.result;
  }
  reader.readAsDataURL(event.target.files[0]);
}

function removePhoto(){
  document.getElementById('photoPreview').src = "https://via.placeholder.com/100";
  document.getElementById('photoInput').value = ""; // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† input ÙØ§ÛŒÙ„
}
/*
  ÙØ§ÛŒÙ„ Ú©Ø§Ù…Ù„ Ùˆ ØªÙ…ÛŒØ²Ù Ù¾Ù†Ù„ ÙŠØ¯Ú©â€ŒÚ©Ø´
  - ÛŒÚ© Ø¨Ø§Ø± listenerÙ‡Ø§ ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯
  - Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø§Ø±Ú©Ø±Ù‡Ø§ Ùˆ Ù…Ø³ÛŒØ±Ù‡Ø§
  - Ù¾Ù†Ù„ Ù¾Ø§ÛŒÛŒÙ† (Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø§Ù†Ù†Ø¯Ù‡) Ùˆ Ù¾Ù†Ù„ Ù…Ø§Ù…ÙˆØ±ÛŒØª (Ù¾Ø³ Ø§Ø² Ù‚Ø¨ÙˆÙ„)
  - clean-up Ù…Ø±ØªØ¨ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªÚ©Ø±Ø§Ø± Ù„Ø§ÛŒÙ‡â€ŒÙ‡Ø§
*/

/* ========== Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ù†Ù‚Ø´Ù‡ ========== */
const map = L.map('map').setView([30.4391,49.089], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);

/* ========== Ù…ØªØºÙŠØ±Ù‡Ø§Ù‰ Ø­Ø§Ù„Øª ========== */
let towMarker = null;               // Ù…Ø§Ø±Ú©Ø± ÙŠØ¯Ú©â€ŒÚ©Ø´ (Ø®ÙˆØ¯Ù…Ø§Ù†)
let driverMarker = null;            // Ù…Ø§Ø±Ú©Ø± Ø±Ø§Ù†Ù†Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÙØ¹Ù„ÛŒ
let destMarker = null;              // Ù…Ø§Ø±Ú©Ø± Ù…Ù‚ØµØ¯ Ø±Ø§Ù†Ù†Ø¯Ù‡
let driverRouteLine = null;         // Ù…Ø³ÛŒØ± Ø±Ø§Ù†Ù†Ø¯Ù‡ -> Ù…Ù‚ØµØ¯ (Ø¢Ø¨ÛŒ)
let towRouteLine = null;            // Ù…Ø³ÛŒØ± ÙŠØ¯Ú©â€ŒÚ©Ø´ -> Ø±Ø§Ù†Ù†Ø¯Ù‡ (Ù‚Ø±Ù…Ø²)
let currentRequestId = null;        // Ø¢ÛŒØ¯ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¬Ø§Ø±ÛŒ
let currentDriverSocketId = null;   // socket id Ø±Ø§Ù†Ù†Ø¯Ù‡ Ú©Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø§ ÙØ±Ø³ØªØ§Ø¯Ù‡

/* ========== helper: Ù¾Ù†Ù„ Ú©Ø´ÙˆÛŒÛŒ ========== */
function togglePanel(){ document.getElementById('slidePanel').classList.toggle('open'); }

/* ========== Ø¹Ú©Ø³ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ========== */
function previewPhoto(e){
  const file = e.target.files && e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = () => { document.getElementById('photoPreview').src = reader.result; };
  reader.readAsDataURL(file);
}

/* ========== Ø«Ø¨Øª ÙŠØ¯Ú©â€ŒÚ©Ø´ Ø§Ø² Ø·Ø±ÛŒÙ‚ API (Ø§Ø®ØªÛŒØ§Ø±ÛŒ) ========== */
function saveTow(){
  const data = {
    fullName: document.getElementById('towName').value,
    towModel: document.getElementById('towModel').value,
    phone: document.getElementById('towPhone').value,
    towCity: document.getElementById('towCity').value,
    plate: document.getElementById('towPlate').value
  };
  if(!data.fullName){ alert("Ù„Ø·ÙØ§ Ù†Ø§Ù… ÙŠØ¯Ú©â€ŒÚ©Ø´ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÙŠØ¯"); return; }
  fetch("https://naji-backend.onrender.com/api/tow/signup", {
    method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(data)
  }).then(r=>r.json()).then(j=>{ alert(j.message || "Ø«Ø¨Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯"); })
    .catch(err=>{ console.error(err); alert("Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª (Ú©Ù†Ø³ÙˆÙ„ Ø±Ø§ Ú†Ú© Ú©Ù†ÙŠØ¯)."); });
}

/* ========== Ù…ÙˆÙ‚Ø¹ÙŠØª ÙŠØ¯Ú©â€ŒÚ©Ø´ ========== */
function setCurrentLocation(){
  if(!navigator.geolocation){ alert("Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø´Ù…Ø§ Ø§Ø² Geolocation Ù¾Ø´ØªÙŠØ¨Ø§Ù†ÙŠ Ù†Ù…ÙŠâ€ŒÚ©Ù†Ø¯"); return; }
  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude, lng = pos.coords.longitude;
    const latlng = [lat, lng];
    if(towMarker){ towMarker.setLatLng(latlng); }
    else {
      towMarker = L.marker(latlng).addTo(map).bindPopup("Ù…ÙˆÙ‚Ø¹ÙŠØª ÙŠØ¯Ú©â€ŒÚ©Ø´").openPopup();
    }
    map.setView(latlng, 14);
  }, err => {
    alert("Ø¯Ø³ØªØ±Ø³ÙŠ Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹ÙŠØª ÙØ¹Ù„ÙŠ Ø§Ù…Ú©Ø§Ù†â€ŒÙ¾Ø°ÙŠØ± Ù†Ø´Ø¯: " + (err.message || err.code));
  });
}

/* ========== Socket.IO ========== */
const socket = io("https://naji-backend.onrender.com");

/* Ø«Ø¨Øª ÙŠØ¯Ú©â€ŒÚ©Ø´ Ù‡Ù†Ú¯Ø§Ù… ÙˆØµÙ„ Ø´Ø¯Ù† */
socket.on('connect', () => {
  console.log("Ù…ØªØµÙ„ Ø¨Ù‡ Ø³Ø±ÙˆØ±ØŒ socket id:", socket.id);
  socket.emit('registerTow'); // Ø³Ø±ÙˆØ± Ø§ÙŠÙ† event Ø±Ø§ Ú¯ÙˆØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯
});

/* Ø§Ø±Ø³Ø§Ù„ Ù…ÙˆÙ‚Ø¹ÙŠØª ÙŠØ¯Ú©â€ŒÚ©Ø´ Ù‡Ø± 3 Ø«Ø§Ù†ÙŠÙ‡ (Ø§Ú¯Ø± Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯) */
setInterval(() => {
  if(!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude, lng = pos.coords.longitude;
    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÙŠ Ù…Ø§Ø±Ú©Ø± Ù…Ø­Ù„ÙŠ
    if(towMarker) towMarker.setLatLng([lat, lng]);
    // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±
    socket.emit('updateTowLocation', { towId: socket.id, lat, lng });
  }, ()=>{/* silent fail */});
}, 3000);

/* ========== Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÙŠ Ù„Ø§ÛŒÙ‡â€ŒÙ‡Ø§ Ùˆ ÙˆØ¶Ø¹ÛŒØª Ø¯Ø±Ø®ÙˆØ§Ø³Øª ========== */
function cleanupRequest(){
  currentRequestId = null;
  currentDriverSocketId = null;

  if(driverMarker){ map.removeLayer(driverMarker); driverMarker = null; }
  if(destMarker){ map.removeLayer(destMarker); destMarker = null; }
  if(driverRouteLine){ map.removeLayer(driverRouteLine); driverRouteLine = null; }
  if(towRouteLine){ map.removeLayer(towRouteLine); towRouteLine = null; }

  document.getElementById('driverRequestPanel').style.display = 'none';
  document.getElementById('towTripPanel').style.display = 'none';
  // clear trip info
  document.getElementById('tripDriverName').innerText = "Ù†Ø§Ù…: -";
  document.getElementById('tripDriverPhone').innerText = "ØªÙ„ÙÙ†: -";
  document.getElementById('tripDriverPlate').innerText = "Ù¾Ù„Ø§Ú©: -";
  document.getElementById('tripDriverImage').src = "https://via.placeholder.com/64";
  // Ù…Ø³ÛŒØ± info Ø¯Ø± Ù¾Ù†Ù„ Ú©Ù†Ø§Ø±ÛŒ
  document.getElementById('towDistance').innerText = "ÙØ§ØµÙ„Ù‡: -";
  document.getElementById('towDuration').innerText = "Ø²Ù…Ø§Ù† ØªÙ‚Ø±ÙŠØ¨ÛŒ: -";
}

/* ========== Ø±Ø³Ù… Ù…Ø³ÙŠØ± Ø¨Ø§ OSRM Ùˆ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª ========== */
async function drawRouteLines(start, end, color="blue"){
  // start, end : {lat:..., lng:...} ÛŒØ§ Leaflet LatLng
  try {
    const sLng = start.lng ?? start[1] ?? start.lon ?? start.longitude ?? start.lon;
  } catch(e){}
  const sLngVal = start.lng ?? (Array.isArray(start) ? start[1] : start.lng);
  // Build URL: lon,lat;lon,lat
  const url = `https://router.project-osrm.org/route/v1/driving/${start.lng ?? start[1]},${start.lat ?? start[0]};${end.lng ?? end[1]},${end.lat ?? end[0]}?overview=full&geometries=geojson`;
  try {
    const res = await fetch(url);
    if(!res.ok) throw new Error("OSRM error");
    const json = await res.json();
    if(json.routes && json.routes.length>0){
      const route = json.routes[0];
      const coords = route.geometry.coordinates.map(c=>[c[1], c[0]]); // [lat,lng]
      const distance = (route.distance/1000).toFixed(2);
      const duration = Math.ceil(route.duration/60);
      const poly = L.polyline(coords, { color, weight:4 }).addTo(map);
      map.fitBounds(poly.getBounds(), {padding:[40,40]});

      // Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ù„Ø§ÛŒÙ‡â€ŒÙ‡Ø§
      if(color === 'blue'){
        if(driverRouteLine) map.removeLayer(driverRouteLine);
        driverRouteLine = poly;
      } else if(color === 'red'){
        if(towRouteLine) map.removeLayer(towRouteLine);
        towRouteLine = poly;
        // Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø³ÛŒØ± ÙŠØ¯Ú©â€ŒÚ©Ø´ -> Ø±Ø§Ù†Ù†Ø¯Ù‡ Ø¯Ø± Ù¾Ù†Ù„ Ú©Ù†Ø§Ø±ÛŒ
        document.getElementById('towDistance').innerText = `ÙØ§ØµÙ„Ù‡: ${distance} km`;
        document.getElementById('towDuration').innerText = `Ø²Ù…Ø§Ù† ØªÙ‚Ø±ÙŠØ¨ÛŒ: ${duration} Ø¯Ù‚ÙŠÙ‚Ù‡`;
      }
      return { distance, duration, poly };
    }
  } catch(err){
    console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÙŠØ§ÙØª/Ø±Ø³Ù… Ù…Ø³ÙŠØ±:", err);
  }
  return null;
}

/* ========== Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø² Ø±Ø§Ù†Ù†Ø¯Ù‡ ========== */
// Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† listenerÙ‡Ø§ØŒ Ù‚Ø·Ø¹Ø´ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ø¬Ø±Ø§ Ù†Ø´ÙˆÙ†Ø¯ (Ø§ÛŒÙ…Ù†)
socket.off('receiveRequest');
socket.on('receiveRequest', async (data) => {
  // data: { requestId, driverSocketId, origin, dest, driverInfo }
  cleanupRequest(); // Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ù‡Ø± Ø­Ø§Ù„Øª Ù‚Ø¨Ù„ÛŒ
  currentRequestId = data.requestId;
  currentDriverSocketId = data.driverSocketId || data.driverId || null;
  const d = data.driverInfo || {};

  // Ù¾Ø± Ú©Ø±Ø¯Ù† Ù¾Ù†Ù„ Ù¾Ø§ÛŒÛŒÙ†
  document.getElementById('reqDriverImage').src = d.image || 'https://via.placeholder.com/64';
  document.getElementById('driverName').innerText = (d.fullName ? `Ù†Ø§Ù…: ${d.fullName}` : "Ù†Ø§Ù…: -");
  document.getElementById('driverPhone').innerText = (d.phone ? `ØªÙ„ÙÙ†: ${d.phone}` : "ØªÙ„ÙÙ†: -");
  document.getElementById('driverCoords').innerText = `Ù…Ø¨Ø¯Ø§: ${data.origin.lat.toFixed(5)}, ${data.origin.lng.toFixed(5)}`;
  document.getElementById('driverDest').innerText = `Ù…Ù‚ØµØ¯: ${data.dest.lat.toFixed(5)}, ${data.dest.lng.toFixed(5)}`;
  document.getElementById('driverRequestPanel').style.display = 'block';

  // Ù¾Ø®Ø´ ØµØ¯Ø§ Ø¨Ø±Ø§ÛŒ Ø¬Ù„Ø¨ ØªÙˆØ¬Ù‡
  try { new Audio('https://cdn.pixabay.com/download/audio/2022/03/15/audio_bass-drop-12345.mp3?filename=bass-drop-3.mp3').play(); } catch(e){}

  // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù…Ø§Ø±Ú©Ø± Ø±Ø§Ù†Ù†Ø¯Ù‡ Ùˆ Ù…Ù‚ØµØ¯ Ø¨Ù‡ Ù†Ù‚Ø´Ù‡
  driverMarker = L.marker([data.origin.lat, data.origin.lng], {
    icon: L.icon({ iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png", iconSize:[32,32] })
  }).addTo(map).bindPopup("Ø±Ø§Ù†Ù†Ø¯Ù‡");

  destMarker = L.marker([data.dest.lat, data.dest.lng], {
    icon: L.icon({ iconUrl: "https://cdn-icons-png.flaticon.com/512/149/149060.png", iconSize:[32,32] })
  }).addTo(map).bindPopup("Ù…Ù‚ØµØ¯");

  // Ø±Ø³Ù… Ù…Ø³ÛŒØ± Ø±Ø§Ù†Ù†Ø¯Ù‡ -> Ù…Ù‚ØµØ¯ (Ø¢Ø¨ÛŒ)
  await drawRouteLines(data.origin, data.dest, "blue");

  // Ø§Ú¯Ø± Ù…Ø­Ù„ ÙŠØ¯Ú©â€ŒÚ©Ø´ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ù‡ØŒ Ù…Ø³ÛŒØ± ÙŠØ¯Ú©â€ŒÚ©Ø´ -> Ø±Ø§Ù†Ù†Ø¯Ù‡ Ø±Ùˆ Ø±Ø³Ù… Ú©Ù†
  if(towMarker){
    await drawRouteLines(towMarker.getLatLng(), { lat: data.origin.lat, lng: data.origin.lng }, "red");
  }
});

/* Ø±Ø¯/Ù‚Ø¨ÙˆÙ„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø² Ù¾Ù†Ù„ Ù¾Ø§ÛŒÛŒÙ† */
document.getElementById('btnAcceptRequest').addEventListener('click', () => {
  if(!currentRequestId){
    alert("Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÙŠØ³Øª");
    return;
  }
  const towInfo = {
    fullName: document.getElementById('towName').value || 'ÙŠØ¯Ú©â€ŒÚ©Ø´',
    phone: document.getElementById('towPhone').value || '',
    plate: document.getElementById('towPlate').value || '',
    image: document.getElementById('photoPreview').src || ''
  };

  // Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø® Ù‚Ø¨ÙˆÙ„ Ø¨Ù‡ Ø³Ø±ÙˆØ±
  socket.emit('requestUpdate', { requestId: currentRequestId, status: 'accepted', towInfo });

  // Ù†Ù…Ø§ÙŠØ´ Ù¾Ù†Ù„ Ù…Ø§Ù…ÙˆØ±ÙŠØª Ø¨Ø±Ø§ÛŒ ÙŠØ¯Ú©â€ŒÚ©Ø´
  document.getElementById('towTripPanel').style.display = 'block';
  document.getElementById('tripDriverName').innerText = document.getElementById('driverName').innerText;
  document.getElementById('tripDriverPhone').innerText = document.getElementById('driverPhone').innerText;
  document.getElementById('tripDriverPlate').innerText = document.getElementById('driverPlate')?.innerText || "Ù¾Ù„Ø§Ú©: -";
  document.getElementById('tripDriverImage').src = document.getElementById('reqDriverImage').src || 'https://via.placeholder.com/64';

  // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ù¾Ù†Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª
  document.getElementById('driverRequestPanel').style.display = 'none';
});

document.getElementById('btnRejectRequest').addEventListener('click', () => {
  if(!currentRequestId) { document.getElementById('driverRequestPanel').style.display='none'; return; }
  socket.emit('requestUpdate', { requestId: currentRequestId, status: 'rejected' });
  cleanupRequest();
});


/* ========== Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø±Ø§Ù†Ù†Ø¯Ù‡ (Ù„Ø§ÛŒÙˆ) ========== */
socket.off('updateDriverLocation');
socket.on('updateDriverLocation', (data) => {
  // data: { driverId, lat, lng } (Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ø³Ø±ÙˆØ±)
  if(!currentDriverSocketId) return; // Ø§Ù„Ø§Ù† Ø±Ø¨Ø·ÛŒ Ù†Ø¯Ø§Ø±Ø¯
  if(data.driverId !== currentDriverSocketId) return; // ÙÙ‚Ø· Ø±Ø§Ù†Ù†Ø¯Ù‡Ù” ÙØ¹Ù„ÛŒ Ø±Ø§ Ø¯Ù†Ø¨Ø§Ù„ Ú©Ù†

  const latlng = [data.lat, data.lng];
  // Ø§Ú¯Ø± driverMarker Ø¯Ø§Ø±ÛŒÙ… Ø¢Ù† Ø±Ø§ Ø­Ø±Ú©Øª Ø¨Ø¯Ù‡ØŒ ÙˆÚ¯Ø±Ù†Ù‡ Ø¨Ø³Ø§Ø²
  if(driverMarker) driverMarker.setLatLng(latlng);
  else {
    driverMarker = L.marker(latlng).addTo(map).bindPopup("Ø±Ø§Ù†Ù†Ø¯Ù‡");
  }

  // Ø§Ú¯Ø± Ù…Ø§Ø±Ú©Ø± ÙŠØ¯Ú©â€ŒÚ©Ø´ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ù‡: Ø¨Ù‡â€ŒØ±ÙˆØ² Ú©Ø±Ø¯Ù† Ù…Ø³ÛŒØ± ÙŠØ¯Ú©â€ŒÚ©Ø´ -> Ø±Ø§Ù†Ù†Ø¯Ù‡
  if(towMarker){
    drawRouteLines(towMarker.getLatLng(), { lat: data.lat, lng: data.lng }, "red");
  }
});

/* ========== ÙˆÙ‚ØªÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª ØªÙˆØ³Ø· ÙŠØ¯Ú©â€ŒÚ©Ø´ Ø¯ÙŠÚ¯Ø±ÛŒ Ø¨Ø³ØªÙ‡ Ø´Ø¯ (server emits requestClosed) ========== */
socket.off('requestClosed');
socket.on('requestClosed', (info) => {
  // info may contain requestId and message
  if(info && info.requestId && currentRequestId && info.requestId !== currentRequestId){
    // not our request -> ignore
    return;
  }
  alert(info.message || 'Ø§ÙŠÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø³ØªÙ‡ Ø´Ø¯.');
  cleanupRequest();
});

/* ========== Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ù¾Ø§ÛŒØ§Ù†/Ù„ØºÙˆ Ù…Ø£Ù…ÙˆØ±ÛŒØª Ú©Ù‡ Ø§Ø² Ø³Ø±ÙˆØ± Ù…ÛŒâ€ŒØ¢ÛŒØ¯ ========== */
socket.off('tripEnded');
socket.on('tripEnded', (info) => {
  if(info && info.requestId && currentRequestId && info.requestId !== currentRequestId) return;
  alert('Ù…Ø§Ù…ÙˆØ±ÙŠØª Ù¾Ø§ÙŠØ§Ù† ÙŠØ§ÙØª.');
  cleanupRequest();
});

socket.off('tripCanceled');
socket.on('tripCanceled', (info) => {
  if(info && info.requestId && currentRequestId && info.requestId !== currentRequestId) return;
  alert('Ù…Ø§Ù…ÙˆØ±ÙŠØª Ù„ØºÙˆ Ø´Ø¯.');
  cleanupRequest();
});

/* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ù†Ù„ Ù…Ø§Ù…ÙˆØ±ÛŒØª (ÙŠØ¯Ú©â€ŒÚ©Ø´ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù¾Ø§ÛŒØ§Ù† ÛŒØ§ Ù„ØºÙˆ Ø¨Ø²Ù†Ø¯) */
document.getElementById('btnTowEnd').addEventListener('click', () => {
  if(!currentRequestId){ alert("Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯"); return; }
  socket.emit('endTrip', { requestId: currentRequestId });
  cleanupRequest();
});

document.getElementById('btnTowCancel').addEventListener('click', () => {
  if(!currentRequestId){ alert("Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯"); return; }
  socket.emit('cancelTrip', { requestId: currentRequestId });
  cleanupRequest();
});

/* Ø´Ø¨ÙŠÙ‡â€ŒØ³Ø§Ø²ÙŠ (Ø¯Ø³Øª Ø®ÙˆØ¯ØªØ§Ù†): Ø§Ú¯Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ù¾Ù†Ù„ ØªØ³Øª Ú©Ù†ÛŒØ¯ */
function simulateReceive(){
  // Ù†Ù…ÙˆÙ†Ù‡ Ø¯Ø§Ø¯Ù‡ ØªØ³ØªÛŒ (Ù…Ø®ØªØµØ§Øª ØªØµØ§Ø¯ÙÛŒ Ù†Ø²Ø¯ÛŒÚ©)
  const origin = { lat: 30.4405, lng: 49.0885 };
  const dest = { lat: 30.4510, lng: 49.0960 };
  const driverInfo = { fullName: "Ø¹Ù„ÛŒ Ø±Ø¶Ø§ÛŒÛŒ", phone: "0912xxxxxxx", plate: "Ø§ÛŒØ±Ø§Ù† 12 Ø¨ 345" };
  socket.emit('receiveRequest', { requestId: "sim-"+Date.now(), driverSocketId: "sim-driver", origin, dest, driverInfo });
  // ØªÙˆØ¬Ù‡: Ø³Ø±ÙˆØ± ÙˆØ§Ù‚Ø¹ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø§ Ø§Ø² Ø±Ø§Ù†Ù†Ø¯Ù‡ Ø¨Ù‡ ØªÙˆ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯Ø› Ø§ÛŒÙ† Ø´Ø¨ÙŠÙ‡â€ŒØ³Ø§Ø²ÙŠ ÙÙ‚Ø· UI Ø±Ø§ ØªØ³Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
  // Ø¨Ø±Ø§ÛŒ ØªØ³Øª ÙˆØ§Ù‚Ø¹ÛŒØŒ Ø±Ø§Ù†Ù†Ø¯Ù‡ ÙØ§ÛŒÙ„ driver.html Ø±Ø§ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù‡ Ùˆ requestService Ø±Ø§ Ø¨Ø²Ù†Ø¯.
}

/* ØªÙ‡ÙŠÙ‡ Ú©Ù„ÙŠØ¯Ù‡Ø§ÙŠ Ù„Ø§Ø²Ù… Ø¬Ù‡Øª Ø¬Ù„ÙˆÚ¯ÙŠØ±ÙŠ Ø§Ø² Ú†Ù†Ø¯ ØªØ¹Ø±ÙŠÙÛŒ (Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯) */
window.addEventListener('beforeunload', () => {
  // optionally notify server of disconnect (socket.io will handle)
});

/* Ø§Ù…Ù†ÙŠØª/Ø§Ø´Ú©Ø§Ù„â€ŒØ²Ø¯Ø§ÛŒÛŒ */
console.log("tow panel loaded");
</script>
</body>
</html>

