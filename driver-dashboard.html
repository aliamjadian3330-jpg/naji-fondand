<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø±Ø§Ù†Ù†Ø¯Ù‡ Ø­Ø±ÙÙ‡â€ŒØ§ÙŠ</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
*{margin:0; padding:0; box-sizing:border-box; font-family:'Roboto',sans-serif;}
body,html{height:100%; width:100%; background:#f0f2f5;}

/* Map */
#mapContainer{height:100vh; width:100%; position:relative;}
#map{height:100%; width:100%; border-radius:8px;}

/* Slide Panel Right */
#slidePanel{
  position:absolute;
  top:0; right:-300px; /* Ù…Ø®ÙÙŠ Ø®Ø§Ø±Ø¬ ØµÙØ­Ù‡ */
  width:280px; height:100%;
  background:#3b82f6; color:white;
  padding:15px; transition:right 0.4s ease;
  z-index:1000; overflow:auto;
  border-top-left-radius:12px; border-bottom-left-radius:12px;
}
#slidePanel.open{right:0;}

/* Panel Content */
#slidePanel h2{margin-bottom:10px; text-align:center;}
#slidePanel input, #slidePanel select{
  width:100%; padding:10px; margin-bottom:10px; border-radius:6px; border:1px solid #d1d5db;
}
#slidePanel button{
  width:100%; padding:10px; border:none; border-radius:6px; cursor:pointer; margin-top:5px;
}
.btn-primary{background:#3b82f6;color:white;}
.btn-success{background:#10b981;color:white;}
.btn-danger{background:#ef4444;color:white;}
#photoPreview{width:100px;height:100px;border-radius:50%;object-fit:cover;margin:10px auto;display:block;}
ul#driverInfo{list-style:none; padding-left:0; margin-bottom:10px;}
ul#driverInfo li{padding:5px 0;}

/* Toggle Button */
#toggleBtn{
  position:absolute; top:15px; right:15px;
  background:#3b82f6;color:white;
  border:none; border-radius:50%; width:50px; height:50px;
  font-size:24px; cursor:pointer; z-index:1001;
  display:flex; justify-content:center; align-items:center; box-shadow:0 2px 6px rgba(0,0,0,0.3);
}
</style>
</head>
<body>

<div id="mapContainer">
  <div id="map"></div>

  <!-- Toggle Button -->
  <button id="toggleBtn" onclick="togglePanel()">?</button>

  <!-- Slide Panel -->
  <div id="slidePanel">
    <h2>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø±Ø§Ù†Ù†Ø¯Ù‡</h2>

    <!-- Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø§Ù†Ù†Ø¯Ù‡ -->
    <ul id="driverInfo"></ul>

    <!-- Ø¢Ù¾Ù„ÙˆØ¯ Ø¹Ú©Ø³ -->
    <div>
      <h3>Ø¢Ù¾Ù„ÙˆØ¯ Ø¹Ú©Ø³</h3>
      <img id="photoPreview" src="" alt="Ù¾ÙŠØ´â€ŒÙ†Ù…Ø§ÙŠØ´ Ø¹Ú©Ø³">
      <input type="file" id="photoInput" onchange="previewPhoto(event)">
    </div>

    <!-- Ù†Ø¸Ø± Ø³Ù†Ø¬ÙŠ -->
    <div>
      <h3>Ù†Ø¸Ø± Ø³Ù†Ø¬ÙŠ Ø±Ø§Ù†Ù†Ø¯Ù‡</h3>
      <select id="surveyRating">
        <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÙŠØ¯</option>
        <option value="1">1 - Ø®ÙŠÙ„ÙŠ Ø¨Ø¯</option>
        <option value="2">2 - Ø¨Ø¯</option>
        <option value="3">3 - Ù…ØªÙˆØ³Ø·</option>
        <option value="4">4 - Ø®ÙˆØ¨</option>
        <option value="5">5 - Ø¹Ø§Ù„ÙŠ</option>
      </select>
      <button class="btn-primary" onclick="submitSurvey()">Ø§Ø±Ø³Ø§Ù„</button>
    </div>

    <!-- ÙØ±Ù… Ø«Ø¨Øª Ù†Ø§Ù… -->
    <div>
      <h3>Ø«Ø¨Øª Ù†Ø§Ù…</h3>
      <input type="text" id="name" placeholder="Ù†Ø§Ù…">
      <input type="text" id="phone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³">
      <input type="text" id="carName" placeholder="Ù†Ø§Ù… Ø®ÙˆØ¯Ø±Ùˆ">
      <input type="text" id="plate" placeholder="Ù¾Ù„Ø§Ú© Ø®ÙˆØ¯Ø±Ùˆ">
      <input type="text" id="carColor" placeholder="Ø±Ù†Ú¯ Ø®ÙˆØ¯Ø±Ùˆ (Ù…Ø«Ù„ red ÙŠØ§ #ff0000)">
      <button class="btn-success" onclick="register()">Ø«Ø¨Øª Ù†Ø§Ù…</button>
    </div>

    <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÙŠ Ù†Ù‚Ø´Ù‡ -->
    <div style="margin-top:10px;">
      <button class="btn-success" onclick="setCurrentLocation()">Ù…ÙˆÙ‚Ø¹ÙŠØª Ù…Ù†</button>
      <button class="btn-primary" onclick="lockOrigin()">Ù‚ÙÙ„ Ù…Ø¨Ø¯Ø§</button>
      <button class="btn-danger" onclick="unlockOrigin()">Ø¢Ø²Ø§Ø¯Ø³Ø§Ø²ÙŠ Ù…Ø¨Ø¯Ø§</button>
      <button class="btn-primary" onclick="requestService()">Ø¯Ø±Ø®ÙˆØ§Ø³Øª</button>

    </div>

    <!-- Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø³ÙŠØ± -->
    <div style="margin-top:10px; background:white; color:black; padding:10px; border-radius:8px;">
      <strong>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø³ÙŠØ±:</strong>
      <p id="distance">ÙØ§ØµÙ„Ù‡: -</p>
      <p id="duration">Ø²Ù…Ø§Ù† ØªÙ‚Ø±ÙŠØ¨ÙŠ: -</p>
    </div>
  </div>
</div>
<!-- Ù¾Ù†Ù„ Ø§Ù†ØªØ¸Ø§Ø± -->
<div id="waitingPanel" style="display:none;">
  <div style="background:white;color:#111;padding:30px 40px;border-radius:12px;text-align:center;box-shadow:0 10px 25px rgba(0,0,0,0.3);min-width:280px;">
    <h2 style="margin-bottom:15px;">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨ÙˆÙ„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª...</h2>
    <p>Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯ØŒ Ø¨Ù‡ Ù…Ø­Ø¶ Ù‚Ø¨ÙˆÙ„ ØªÙˆØ³Ø· ÛŒØ¯Ú©â€ŒÚ©Ø´ Ø§Ø·Ù„Ø§Ø¹ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p>
    <div style="margin-top:20px;">
      <div class="loader" style="border:4px solid #f3f3f3;border-top:4px solid #3b82f6;border-radius:50%;width:40px;height:40px;margin:0 auto;animation:spin 1s linear infinite;"></div>
    </div>
  </div>
</div>

<style>
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
@keyframes fadeIn{0%{opacity:0;}100%{opacity:1;}}
</style>

<!-- Ù¾Ù†Ù„ Ù¾Ø§ÛŒÛŒÙ† Ø±Ø§Ù†Ù†Ø¯Ù‡ -->
<div id="tripPanel" style="display:none; position:fixed; bottom:0; left:0; right:0; background:#fff; border-top:2px solid #3b82f6; padding:15px; z-index:1001; box-shadow:0 -2px 8px rgba(0,0,0,0.2);">
  <h3>Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÛŒØ¯Ú©â€ŒÚ©Ø´</h3>
  <p id="infoTowName">Ù†Ø§Ù…: -</p>
  <p id="infoTowPhone">ØªÙ„ÙÙ†: -</p>
  <p id="infoTowPlate">Ù¾Ù„Ø§Ú©: -</p>
  <p id="towDistance">ÙØ§ØµÙ„Ù‡: -</p>
  <p id="towDuration">Ø²Ù…Ø§Ù† ØªÙ‚Ø±ÛŒØ¨ÛŒ: -</p>
  <button id="btnCancelTrip" style="background:#ef4444; color:#fff; padding:10px; margin:5px; border:none; border-radius:8px;">Ù„ØºÙˆ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</button>
  <button id="btnEndTrip" style="background:#10b981; color:#fff; padding:10px; margin:5px; border:none; border-radius:8px;">Ù¾Ø§ÛŒØ§Ù† Ù…Ø£Ù…ÙˆØ±ÛŒØª</button>
</div>



<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<!-- socket.IO -->
 <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  
/* Map */
const map = L.map('map').setView([35.6895,51.3890],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);

/* Slide Panel */
function togglePanel(){ document.getElementById('slidePanel').classList.toggle('open'); }

/* Ø±Ø§Ù†Ù†Ø¯Ù‡ */
window.onload = function(){
  const driverData = localStorage.getItem("driverData");
  if(driverData){
    fillDashboard(JSON.parse(driverData));
  } else {
    alert("Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÙŠØ¯");
    window.location.href = "driver-login.html";
  }
}

function register(){
  const data={
    name:document.getElementById('name').value,
    phone:document.getElementById('phone').value,
    carName:document.getElementById('carName').value,
    plate: document.getElementById('plate').value,
    carColor:document.getElementById('carColor').value
  };
  localStorage.setItem("driverData",JSON.stringify(data));
  fillDashboard(data);
  alert("Ø«Ø¨Øª Ù†Ø§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÙŠØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!");
}

function fillDashboard(data){
  const list = document.getElementById('driverInfo');
  list.innerHTML = "";
  const items = [
    `Ù†Ø§Ù…: ${data.name}`,
    `Ø´Ù…Ø§Ø±Ù‡: ${data.phone}`,
    `Ø®ÙˆØ¯Ø±Ùˆ: ${data.carName}`,
    `Ø±Ù†Ú¯ Ø®ÙˆØ¯Ø±Ùˆ: <span style="display:inline-block;width:15px;height:15px;background:${data.carColor};border:1px solid #000;margin-left:5px;vertical-align:middle;"></span> ${data.carColor}`
  ];
  items.forEach(text => {
    const li = document.createElement('li');
    li.innerHTML = text;
    list.appendChild(li);
  });
}

/* Ø¢Ù¾Ù„ÙˆØ¯ Ø¹Ú©Ø³ */
function previewPhoto(event){
  const reader=new FileReader();
  reader.onload=function(){document.getElementById('photoPreview').src=reader.result;}
  reader.readAsDataURL(event.target.files[0]);
}

/* Ù†Ø¸Ø± Ø³Ù†Ø¬ÙŠ */
function submitSurvey(){
  const rating=document.getElementById('surveyRating').value;
  if(!rating){ alert("Ù„Ø·ÙØ§ Ø§Ù…ØªÙŠØ§Ø² Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÙŠØ¯"); return; }
  alert("Ø¨Ø§ ØªØ´Ú©Ø± Ø§Ø² Ù†Ø¸Ø± Ø´Ù…Ø§: "+rating+"/5");
  document.getElementById('surveyRating').value = "";
}

/* Ù†Ù‚Ø´Ù‡ Ù…Ø¨Ø¯Ø§ Ùˆ Ù…Ù‚ØµØ¯ */
let originMarker=null, destinationMarker=null, routeLine=null, liveMarker=null;

map.on('click', function(e){
  if(!originMarker){
    originMarker=L.marker(e.latlng,{draggable:true}).addTo(map).bindPopup("Ù…Ø¨Ø¯Ø§").openPopup();
  } else if(!destinationMarker){
    destinationMarker=L.marker(e.latlng,{draggable:true}).addTo(map).bindPopup("Ù…Ù‚ØµØ¯").openPopup();
  } else {
    const choice = confirm("Ú©Ø¯Ø§Ù… Ø±Ø§ ØªØºÙŠÙŠØ± Ù…ÙŠâ€ŒØ®ÙˆØ§ÙŠØŸ OK = Ù…Ø¨Ø¯Ø§, Cancel = Ù…Ù‚ØµØ¯");
    if(choice){ originMarker.setLatLng(e.latlng).bindPopup("Ù…Ø¨Ø¯Ø§").openPopup(); }
    else { destinationMarker.setLatLng(e.latlng).bindPopup("Ù…Ù‚ØµØ¯").openPopup(); }
    if(routeLine) map.removeLayer(routeLine);
    if(liveMarker) map.removeLayer(liveMarker);
  }
});

function setCurrentLocation(){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const latlng=[pos.coords.latitude,pos.coords.longitude];
      if(originMarker){ originMarker.setLatLng(latlng); } 
      else { originMarker=L.marker(latlng,{draggable:true}).addTo(map).bindPopup("Ù…Ø¨Ø¯Ø§").openPopup(); }
      map.setView(latlng,14);
    });
  }else alert("Ø§Ù…Ú©Ø§Ù† Ø¯Ø±ÙŠØ§ÙØª Ù…ÙˆÙ‚Ø¹ÙŠØª ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!");
}

function lockOrigin(){ if(originMarker){ originMarker.dragging.disable(); originMarker.bindPopup("Ù…Ø¨Ø¯Ø§ (Ù‚ÙÙ„)").openPopup(); } }
function unlockOrigin(){ if(originMarker){ originMarker.dragging.enable(); originMarker.bindPopup("Ù…Ø¨Ø¯Ø§").openPopup(); } }


// socket.IO
let currentRequestId = null;
const socket = io("https://naji-backend.onrender.com");

//   alert('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ Ùˆ Ù…Ù†ØªØ¸Ø± Ù¾Ø§Ø³Ø® ÙŠØ¯Ú©â€ŒÚ©Ø´ Ù‡Ø³ØªÙŠØ¯...');
// }

// Ø¯Ø±ÙŠØ§ÙØª Ø¢Ù¾Ø¯ÙŠØª Ø§Ø² ÙŠØ¯Ú©â€ŒÚ©Ø´

// --- ÙˆÙ‚ØªÛŒ ÛŒØ¯Ú©â€ŒÚ©Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ùˆ Ù‚Ø¨ÙˆÙ„ Ú©Ø±Ø¯
socket.on('requestUpdate', (data) => {
  if(data.status === 'accepted'){
    currentRequestId = data.requestId;
    const tow = data.towInfo;

    document.getElementById('waitingPanel').style.display = 'none';
    document.getElementById('infoTowName').innerText = "Ù†Ø§Ù…: " + tow.fullName;
    document.getElementById('infoTowPhone').innerText = "ØªÙ„ÙÙ†: " + tow.phone;
    document.getElementById('infoTowPlate').innerText = "Ù¾Ù„Ø§Ú©: " + tow.plate;
    document.getElementById('tripPanel').style.display = 'block';
  }
});

// --- Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª Ø²Ù†Ø¯Ù‡ ÛŒØ¯Ú©â€ŒÚ©Ø´ Ùˆ Ø±Ø³Ù… Ù…Ø³ÛŒØ±
socket.on('towLocation', (data) => {
  if(currentRequestId && data.towId){
    const driverLatLng = originMarker.getLatLng();
    const towLatLng = { lat: data.lat, lng: data.lng };
    drawRouteToTow(driverLatLng, towLatLng);
  }
});

// --- Ù„ØºÙˆ Ø¯Ø±Ø®ÙˆØ§Ø³Øª
document.getElementById('btnCancelTrip').addEventListener('click', () => {
  if(currentRequestId){
    socket.emit('cancelTrip', { requestId: currentRequestId });
    document.getElementById('tripPanel').style.display = 'none';
    if(towRouteLine) map.removeLayer(towRouteLine);
  }
});

// --- Ù¾Ø§ÛŒØ§Ù† Ù…Ø£Ù…ÙˆØ±ÛŒØª
document.getElementById('btnEndTrip').addEventListener('click', () => {
  if(currentRequestId){
    socket.emit('endTrip', { requestId: currentRequestId });
    document.getElementById('tripPanel').style.display = 'none';
    if(towRouteLine) map.removeLayer(towRouteLine);
  }
});

// live marker
// Ø§Ø±Ø³Ø§Ù„ Ù…ÙˆÙ‚Ø¹ÙŠØª Ø±Ø§Ù†Ù†Ø¯Ù‡ Ù‡Ø± 3 Ø«Ø§Ù†ÙŠÙ‡
let liveInterval;



function startLiveTracking() {
  if(navigator.geolocation){
    liveInterval = setInterval(() => {
      navigator.geolocation.getCurrentPosition(pos => {
        const latlng = { lat: pos.coords.latitude, lng: pos.coords.longitude };

        // Ø§Ø±Ø³Ø§Ù„ Ù…ÙˆÙ‚Ø¹ÙŠØª Ø¨Ù‡ Ø³Ø±ÙˆØ±
        socket.emit('driverLocation', { driverId: socket.id, lat: latlng.lat, lng: latlng.lng });


        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÙŠ ÙŠØ§ Ø³Ø§Ø®Øª Ù…Ø§Ø±Ú©Ø± Ø±Ø§Ù†Ù†Ø¯Ù‡
        if(!liveMarker){
          liveMarker = L.marker(latlng, {
            icon: L.icon({
              iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
              iconSize: [30,30]
            })
          }).addTo(map).bindPopup("Ø±Ø§Ù†Ù†Ø¯Ù‡");
        } else {
          liveMarker.setLatLng(latlng);
        }
      });
    }, 3000); // Ù‡Ø± 3 Ø«Ø§Ù†ÙŠÙ‡
  } else {
    alert("Ø§Ù…Ú©Ø§Ù† Ø¯Ø±ÙŠØ§ÙØª Ù…ÙˆÙ‚Ø¹ÙŠØª ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!");
  }
}




// Ù‡Ù†Ú¯Ø§Ù… Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø³Ø±ÙˆÙŠØ³ Ø´Ø±ÙˆØ¹ Ù…ÙŠâ€ŒÚ©Ù†ÙŠÙ…
async function requestService() {
  if (!originMarker || !destinationMarker) {
    alert("Ø§Ø¨ØªØ¯Ø§ Ù…Ø¨Ø¯Ø§ Ùˆ Ù…Ù‚ØµØ¯ Ø±Ø§ ØªØ¹ÙŠÙŠÙ† Ú©Ù†ÙŠØ¯");
    return;
  }

  const origin = originMarker.getLatLng();
  const dest = destinationMarker.getLatLng();
  const driverData = JSON.parse(localStorage.getItem("driverData")) || {};

  await getRoute(origin, dest);

  socket.emit("requestService", {
    driverId: socket.id,
    origin,
    dest,
    driverInfo: {
      fullName: driverData.name || '',
      phone: driverData.phone || '',
      plate: driverData.plate || '',
      image: document.getElementById('photoPreview').src || null
    }
  });

  // ğŸ‘ˆ ÙÙ‚Ø· Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
  document.getElementById('waitingPanel').style.display = 'flex';

  startLiveTracking();
}




async function getRoute(origin, destination) {
  try {
    const url = `https://router.project-osrm.org/route/v1/driving/${origin.lng},${origin.lat};${destination.lng},${destination.lat}?overview=full&geometries=geojson`;
    
    const res = await fetch(url);
    const data = await res.json();

    if(data.routes && data.routes.length > 0){
      const route = data.routes[0];
      const coords = route.geometry.coordinates.map(c => [c[1], c[0]]);
      const distance = (route.distance / 1000).toFixed(2); // Ú©ÙŠÙ„ÙˆÙ…ØªØ±
      const duration = Math.ceil(route.duration / 60); // Ø¯Ù‚ÙŠÙ‚Ù‡

      if(routeLine) map.removeLayer(routeLine);
      routeLine = L.polyline(coords, {color:'blue', weight:4}).addTo(map);
      map.fitBounds(routeLine.getBounds());

      document.getElementById('distance').innerText = `ÙØ§ØµÙ„Ù‡: ${distance} km`;
      document.getElementById('duration').innerText = `Ø²Ù…Ø§Ù† ØªÙ‚Ø±ÙŠØ¨ÙŠ: ${duration} Ø¯Ù‚ÙŠÙ‚Ù‡`;

      return { distance, duration };
    }
  } catch(err){
    console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÙŠØ§ÙØª Ù…Ø³ÙŠØ±:", err);
  }
}

let towRouteLine = null;

async function drawRouteToTow(driverLatLng, towLatLng) {
  try {
    const url = `https://router.project-osrm.org/route/v1/driving/${towLatLng.lng},${towLatLng.lat};${driverLatLng.lng},${driverLatLng.lat}?overview=full&geometries=geojson`;
    const res = await fetch(url);
    const data = await res.json();

    if(data.routes && data.routes.length > 0){
      const route = data.routes[0];
      const coords = route.geometry.coordinates.map(c => [c[1], c[0]]);
      const distance = (route.distance / 1000).toFixed(2);
      const duration = Math.ceil(route.duration / 60);

      if(towRouteLine) map.removeLayer(towRouteLine);
      towRouteLine = L.polyline(coords, {color:'red', weight:4}).addTo(map);
      map.fitBounds(towRouteLine.getBounds());

      document.getElementById('towDistance').innerText = `ÙØ§ØµÙ„Ù‡: ${distance} km`;
      document.getElementById('towDuration').innerText = `Ø²Ù…Ø§Ù† ØªÙ‚Ø±ÙŠØ¨ÙŠ: ${duration} Ø¯Ù‚ÙŠÙ‚Ù‡`;
    }
  } catch(err){
    console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÙŠØ§ÙØª Ù…Ø³ÙŠØ±:", err);
  }
}

function cleanupRequest() {
  currentRequestId = null;

  // Ø¨Ø³ØªÙ† Ù¾Ù†Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÛŒØ¯Ú©Ø´
  document.getElementById('tripPanel').style.display = 'none';

  // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù…Ø³ÛŒØ± ÛŒØ¯Ú©Ø´
  if (towRouteLine) {
    map.removeLayer(towRouteLine);
    towRouteLine = null;
  }
  
  // ØªÙˆÙ‚Ù Ø§Ø±Ø³Ø§Ù„ Ù„ÙˆÚ©ÛŒØ´Ù† Ø²Ù†Ø¯Ù‡ Ø±Ø§Ù†Ù†Ø¯Ù‡
  if (liveInterval) {
    clearInterval(liveInterval);
    liveInterval = null;
  }
  // Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø§Ú¯Ù‡ Ø®ÙˆØ§Ø³ØªÛŒ Ù…Ø³ÛŒØ± Ù…Ø¨Ø¯Ø§-Ù…Ù‚ØµØ¯ Ø±Ø§Ù†Ù†Ø¯Ù‡ Ø±Ùˆ Ù‡Ù… Ù¾Ø§Ú© Ú©Ù†ÛŒ
  // if (routeLine) { map.removeLayer(routeLine); routeLine = null; }
}

socket.on('tripEnded', (info) => {
  alert(info.message || "Ù…Ø§Ù…ÙˆØ±ÛŒØª Ù¾Ø§ÛŒØ§Ù† ÛŒØ§ÙØª ØªÙˆØ³Ø· ÛŒØ¯Ú©â€ŒÚ©Ø´");
  // Ø§ÛŒÙ†Ø¬Ø§ Ù‡Ø± UI Ú©Ù‡ Ø®ÙˆØ§Ø³ØªÛŒ ØªØºÛŒÛŒØ± Ø¨Ø¯Ù‡ØŒ Ù…Ø«Ù„Ø§Ù‹ Ù¾Ù†Ù„ Ù…Ø§Ù…ÙˆØ±ÛŒØª Ø±Ùˆ Ø¨Ø¨Ù†Ø¯
  cleanupRequest();
});

socket.on('tripCanceled', (info) => {
  alert(info.message || "Ù…Ø§Ù…ÙˆØ±ÛŒØª Ù„ØºÙˆ Ø´Ø¯ ØªÙˆØ³Ø· ÛŒØ¯Ú©â€ŒÚ©Ø´");
  cleanupRequest();
});


</script>
</body>
</html>

