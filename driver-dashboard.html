<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>داشبورد راننده حرفه‌ای</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
*{margin:0; padding:0; box-sizing:border-box; font-family:'Roboto',sans-serif;}
body,html{height:100%; width:100%; background:#f0f2f5;}
#mapContainer{height:100vh; width:100%; position:relative;}
#map{height:100%; width:100%; border-radius:8px;}
#slidePanel{position:absolute; top:0; right:-300px; width:280px; height:100%; background:#3b82f6; color:white; padding:15px; transition:right 0.4s ease; z-index:1000; overflow:auto; border-top-left-radius:12px; border-bottom-left-radius:12px;}
#slidePanel.open{right:0;}
#slidePanel h2{margin-bottom:10px; text-align:center;}
#slidePanel input, #slidePanel select{width:100%; padding:10px; margin-bottom:10px; border-radius:6px; border:1px solid #d1d5db;}
#slidePanel button{width:100%; padding:10px; border:none; border-radius:6px; cursor:pointer; margin-top:5px;}
.btn-primary{background:#3b82f6;color:white;}
.btn-success{background:#10b981;color:white;}
.btn-danger{background:#ef4444;color:white;}
#photoPreview{width:100px;height:100px;border-radius:50%;object-fit:cover;margin:10px auto;display:block;}
ul#driverInfo{list-style:none; padding-left:0; margin-bottom:10px;}
ul#driverInfo li{padding:5px 0;}
#toggleBtn{position:absolute; top:15px; right:15px; background:#3b82f6;color:white; border:none; border-radius:50%; width:50px; height:50px; font-size:24px; cursor:pointer; z-index:1001; display:flex; justify-content:center; align-items:center; box-shadow:0 2px 6px rgba(0,0,0,0.3);}
#tripPanel{display:none; position:fixed; bottom:0; left:0; right:0; background:#fff; border-top:1px solid #ccc; padding:10px;}
</style>
</head>
<body>

<div id="mapContainer">
  <div id="map"></div>
  <button id="toggleBtn" onclick="togglePanel()">☰</button>

  <div id="slidePanel">
    <h2>داشبورد راننده</h2>
    <ul id="driverInfo"></ul>

    <div>
      <h3>آپلود عکس</h3>
      <img id="photoPreview" src="" alt="پیش‌نمایش عکس">
      <input type="file" id="photoInput" onchange="previewPhoto(event)">
    </div>

    <div style="margin-top:10px;">
      <button class="btn-success" onclick="setCurrentLocation()">موقعیت من</button>
      <button class="btn-primary" onclick="lockOrigin()">قفل مبدا</button>
      <button class="btn-danger" onclick="unlockOrigin()">آزادسازی مبدا</button>
      <button class="btn-primary" onclick="requestService()">درخواست سرویس</button>
    </div>

    <div style="margin-top:10px; background:white; color:black; padding:10px; border-radius:8px;">
      <strong>اطلاعات مسیر:</strong>
      <p id="distance">فاصله: -</p>
      <p id="duration">زمان تقریبی: -</p>
    </div>
  </div>
</div>

<div id="tripPanel">
  <h3>اطلاعات یدک‌کش</h3>
  <p id="infoName">نام: -</p>
  <p id="infoPhone">تلفن: -</p>
  <p id="infoPlate">پلاک: -</p>
  <img id="infoImage" src="" alt="عکس یدک‌کش" style="width:80px;height:80px;border-radius:50%;display:block;margin-bottom:10px;">
  <button id="btnEnd">پایان مأموریت</button>
  <button id="btnCancel">لغو</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
let currentRequestId=null, originMarker=null, destinationMarker=null, routeLine=null, liveMarker=null, towRouteLine=null;
const map=L.map('map').setView([35.6895,51.3890],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);
const socket = io("http://localhost:5000");

// --- Toggle panel ---
function togglePanel(){ document.getElementById('slidePanel').classList.toggle('open'); }

// --- راننده ---
window.onload=function(){
  const driverData = localStorage.getItem("driverData");
  if(driverData){ fillDashboard(JSON.parse(driverData)); }
  else { alert("ابتدا وارد شوید"); window.location.href="driver-login.html"; }
}

function fillDashboard(data){
  const list=document.getElementById('driverInfo'); list.innerHTML="";
  const items=[`نام: ${data.name}`,`شماره: ${data.phone}`,`خودرو: ${data.carName}`];
  items.forEach(text=>{ const li=document.createElement('li'); li.innerHTML=text; list.appendChild(li); });
}

function previewPhoto(e){ const reader=new FileReader(); reader.onload=function(){document.getElementById('photoPreview').src=reader.result;}; reader.readAsDataURL(e.target.files[0]); }
function setCurrentLocation(){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const latlng=[pos.coords.latitude,pos.coords.longitude];
      if(originMarker){ originMarker.setLatLng(latlng).bindPopup("مبدا").openPopup(); }
      else{ originMarker=L.marker(latlng,{draggable:true}).addTo(map).bindPopup("مبدا").openPopup(); }
      map.setView(latlng,14);
    });
  } else alert("امکان دریافت موقعیت وجود ندارد!");
}
function lockOrigin(){ if(originMarker){ originMarker.dragging.disable(); originMarker.bindPopup("مبدا (قفل)").openPopup(); } }
function unlockOrigin(){ if(originMarker){ originMarker.dragging.enable(); originMarker.bindPopup("مبدا").openPopup(); } }

// --- click map ---
map.on('click', function(e){
  if(!originMarker) originMarker=L.marker(e.latlng,{draggable:true}).addTo(map).bindPopup("مبدا").openPopup();
  else if(!destinationMarker) destinationMarker=L.marker(e.latlng,{draggable:true}).addTo(map).bindPopup("مقصد").openPopup();
  else { const choice=confirm("کدام را تغییر می‌خوای؟ OK = مبدا, Cancel = مقصد"); if(choice){ originMarker.setLatLng(e.latlng).bindPopup("مبدا").openPopup(); } else { destinationMarker.setLatLng(e.latlng).bindPopup("مقصد").openPopup(); } }
  if(routeLine) map.removeLayer(routeLine); if(liveMarker) map.removeLayer(liveMarker);
});

// --- رسم مسیر ---
async function getRoute(origin,destination){
  try{
    const url=`https://router.project-osrm.org/route/v1/driving/${origin.lng},${origin.lat};${destination.lng},${destination.lat}?overview=full&geometries=geojson`;
    const res=await fetch(url); const data=await res.json();
    if(data.routes && data.routes.length>0){
      const route=data.routes[0]; const coords=route.geometry.coordinates.map(c=>[c[1],c[0]]);
      const distance=(route.distance/1000).toFixed(2); const duration=Math.ceil(route.duration/60);
      if(routeLine) map.removeLayer(routeLine);
      routeLine=L.polyline(coords,{color:'blue',weight:4}).addTo(map);
      map.fitBounds(routeLine.getBounds());
      document.getElementById('distance').innerText=`فاصله: ${distance} km`;
      document.getElementById('duration').innerText=`زمان تقریبی: ${duration} دقیقه`;
      return {distance,duration};
    }
  }catch(err){ console.error(err); }
}

// --- موقعیت زنده راننده ---
function startLiveTracking(){
  if(navigator.geolocation){
    setInterval(()=>{ navigator.geolocation.getCurrentPosition(pos=>{
      const latlng={lat:pos.coords.latitude,lng:pos.coords.longitude};
      socket.emit('driverLocation',{driverId:socket.id,lat:latlng.lat,lng:latlng.lng});
      if(!liveMarker){ liveMarker=L.marker(latlng,{icon:L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png',iconSize:[30,30]})}).addTo(map).bindPopup("راننده"); } 
      else liveMarker.setLatLng(latlng);
    }); },3000);
  }
}

// --- درخواست سرویس ---
async function requestService(){
  if(!originMarker || !destinationMarker){ alert("ابتدا مبدا و مقصد را تعیین کنید"); return; }
  const origin=originMarker.getLatLng(), dest=destinationMarker.getLatLng();
  await getRoute(origin,dest);
  const driverData=JSON.parse(localStorage.getItem("driverData"))||{};
  socket.emit("requestService",{
    driverId:socket.id, origin, dest,
    driverInfo:{
      fullName:driverData.name||'راننده', phone:driverData.phone||'', plate:driverData.plate||'', image:document.getElementById('photoPreview').src||''
    }
  });
  alert("درخواست ارسال شد و منتظر پاسخ یدک‌کش هستید...");
  startLiveTracking();
}

// --- دریافت آپدیت یدک‌کش ---
socket.on('requestUpdate',(data)=>{
  currentRequestId=data.requestId;
  document.getElementById('infoName').innerText="نام: "+(data.towInfo?.fullName||"نام یدک‌کش");
  document.getElementById('infoPhone').innerText="تلفن: "+(data.towInfo?.phone||"-");
  document.getElementById('infoPlate').innerText="پلاک: "+(data.towInfo?.plate||"-");
  document.getElementById('infoImage').src=data.towInfo?.image||'https://via.placeholder.com/80';
  document.getElementById('tripPanel').style.display='block';

  // مسیر یدک‌کش به راننده
  if(data.towLocation){
    const towLatLng=data.towLocation;
    drawRouteToTow({lat:originMarker.getLatLng().lat,lng:originMarker.getLatLng().lng},towLatLng);
  }
});

// --- مسیر یدک‌کش به راننده ---
async function drawRouteToTow(driverLatLng,towLatLng){
  try{
    const url=`https://router.project-osrm.org/route/v1/driving/${towLatLng.lng},${towLatLng.lat};${driverLatLng.lng},${driverLatLng.lat}?overview=full&geometries=geojson`;
    const res=await fetch(url); const data=await res.json();
    if(data.routes && data.routes.length>0){
      const route=data.routes[0];
      const coords=route.geometry.coordinates.map(c=>[c[1],c[0]]);
      if(towRouteLine) map.removeLayer(towRouteLine);
      towRouteLine=L.polyline(coords,{color:'red',weight:4}).addTo(map);
      map.fitBounds(towRouteLine.getBounds());
    }
  }catch(err){ console.error(err); }
}

// --- پایان و لغو ---
document.getElementById('btnEnd').addEventListener('click',()=>{
  socket.emit('endTrip',{requestId:currentRequestId});
  document.getElementById('tripPanel').style.display='none';
});
document.getElementById('btnCancel').addEventListener('click',()=>{
  socket.emit('cancelTrip',{requestId:currentRequestId});
  document.getElementById('tripPanel').style.display='none';
});
</script>
</body>
</html>
