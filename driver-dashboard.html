<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>داشبورد راننده حرفه‌ای</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
*{margin:0; padding:0; box-sizing:border-box; font-family:'Roboto',sans-serif;}
body,html{height:100%; width:100%; background:#f0f2f5;}

/* Map */
#mapContainer{height:100vh; width:100%; position:relative;}
#map{height:100%; width:100%; border-radius:8px;}

/* Slide Panel Right */
#slidePanel{
  position:absolute;
  top:0; right:-300px;
  width:280px; height:100%;
  background:#3b82f6; color:white;
  padding:15px; transition:right 0.4s ease;
  z-index:1000; overflow:auto;
  border-top-left-radius:12px; border-bottom-left-radius:12px;
}
#slidePanel.open{right:0;}

#slidePanel h2{margin-bottom:10px; text-align:center;}
#slidePanel input, #slidePanel select{
  width:100%; padding:10px; margin-bottom:10px; border-radius:6px; border:1px solid #d1d5db;
}
#slidePanel button{
  width:100%; padding:10px; border:none; border-radius:6px; cursor:pointer; margin-top:5px;
}
.btn-primary{background:#3b82f6;color:white;}
.btn-success{background:#10b981;color:white;}
.btn-danger{background:#ef4444;color:white;}
#photoPreview{width:100px;height:100px;border-radius:50%;object-fit:cover;margin:10px auto;display:block;}
ul#driverInfo{list-style:none; padding-left:0; margin-bottom:10px;}
ul#driverInfo li{padding:5px 0;}

/* Toggle Button */
#toggleBtn{
  position:absolute; top:15px; right:15px;
  background:#3b82f6;color:white;
  border:none; border-radius:50%; width:50px; height:50px;
  font-size:24px; cursor:pointer; z-index:1001;
  display:flex; justify-content:center; align-items:center; box-shadow:0 2px 6px rgba(0,0,0,0.3);
}

/* پنل انتظار */
#waitingPanel{
  display:none;
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.6);
  z-index:2000;
  display:flex; justify-content:center; align-items:center;
}
#waitingPanelContent{
  background:white; color:#111;
  padding:25px 35px;
  border-radius:12px;
  text-align:center;
  box-shadow:0 8px 20px rgba(0,0,0,0.3);
  width:300px;
}
#waitingPanelContent h2{margin-bottom:15px;}

/* پنل ماموریت */
#tripPanel{
  display:none; position:fixed;
  bottom:0; left:0; right:0;
  background:#fff; border-top:2px solid #3b82f6;
  padding:15px; z-index:1001; box-shadow:0 -2px 8px rgba(0,0,0,0.2);
}
#tripPanel p{margin:5px 0;}
#tripPanel button{padding:10px; margin:5px; border:none; border-radius:8px; cursor:pointer;}
</style>
</head>
<body>

<div id="mapContainer">
  <div id="map"></div>

  <!-- Toggle Button -->
  <button id="toggleBtn" onclick="togglePanel()">?</button>

  <!-- Slide Panel -->
  <div id="slidePanel">
    <h2>داشبورد راننده</h2>

    <ul id="driverInfo"></ul>

    <div>
      <h3>آپلود عکس</h3>
      <img id="photoPreview" src="" alt="پيش‌نمايش عکس">
      <input type="file" id="photoInput" onchange="previewPhoto(event)">
    </div>

    <div>
      <h3>ثبت نام</h3>
      <input type="text" id="name" placeholder="نام">
      <input type="text" id="phone" placeholder="شماره تماس">
      <input type="text" id="carName" placeholder="نام خودرو">
      <input type="text" id="plate" placeholder="پلاک خودرو">
      <input type="text" id="carColor" placeholder="رنگ خودرو (مثل red يا #ff0000)">
      <button class="btn-success" onclick="register()">ثبت نام</button>
    </div>

    <div style="margin-top:10px;">
      <button class="btn-success" onclick="setCurrentLocation()">موقعيت من</button>
      <button class="btn-primary" onclick="lockOrigin()">قفل مبدا</button>
      <button class="btn-danger" onclick="unlockOrigin()">آزادسازي مبدا</button>
      <button class="btn-primary" onclick="requestService()">درخواست</button>
    </div>

    <div style="margin-top:10px; background:white; color:black; padding:10px; border-radius:8px;">
      <strong>اطلاعات مسير:</strong>
      <p id="distance">فاصله: -</p>
      <p id="duration">زمان تقريبي: -</p>
    </div>
  </div>
</div>

<!-- پنل انتظار -->
<div id="waitingPanel">
  <div id="waitingPanelContent">
    <h2>منتظر قبول درخواست توسط یدک‌کش هستید...</h2>
    <p>لطفاً منتظر بمانید.</p>
  </div>
</div>

<!-- پنل ماموریت -->
<div id="tripPanel">
  <h3>اطلاعات یدک‌کش</h3>
  <p id="infoTowName">نام: -</p>
  <p id="infoTowPhone">تلفن: -</p>
  <p id="infoTowPlate">پلاک: -</p>
  <p id="towDistance">فاصله: -</p>
  <p id="towDuration">زمان تقریبی: -</p>
  <button id="btnCancelTrip" class="btn-danger">لغو درخواست</button>
  <button id="btnEndTrip" class="btn-success">پایان مأموریت</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
/* ========== نقشه ========== */
const map = L.map('map').setView([35.6895,51.3890],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);

/* Slide Panel */
function togglePanel(){ document.getElementById('slidePanel').classList.toggle('open'); }

/* راننده */
let originMarker=null, destinationMarker=null, routeLine=null, liveMarker=null;

window.onload = function(){
  const driverData = localStorage.getItem("driverData");
  if(driverData){ fillDashboard(JSON.parse(driverData)); }
}

function register(){
  const data={
    name:document.getElementById('name').value,
    phone:document.getElementById('phone').value,
    carName:document.getElementById('carName').value,
    plate: document.getElementById('plate').value,
    carColor:document.getElementById('carColor').value
  };
  localStorage.setItem("driverData",JSON.stringify(data));
  fillDashboard(data);
  alert("ثبت نام با موفقیت انجام شد!");
}

function fillDashboard(data){
  const list = document.getElementById('driverInfo');
  list.innerHTML = "";
  const items = [
    `نام: ${data.name}`,
    `شماره: ${data.phone}`,
    `خودرو: ${data.carName}`,
    `رنگ خودرو: <span style="display:inline-block;width:15px;height:15px;background:${data.carColor};border:1px solid #000;margin-left:5px;vertical-align:middle;"></span> ${data.carColor}`
  ];
  items.forEach(text => { const li = document.createElement('li'); li.innerHTML = text; list.appendChild(li); });
}

/* آپلود عکس */
function previewPhoto(event){
  const reader=new FileReader();
  reader.onload=function(){document.getElementById('photoPreview').src=reader.result;}
  reader.readAsDataURL(event.target.files[0]);
}

/* نقشه مبدا و مقصد */
map.on('click', function(e){
  if(!originMarker){ originMarker=L.marker(e.latlng,{draggable:true}).addTo(map).bindPopup("مبدا").openPopup();}
  else if(!destinationMarker){ destinationMarker=L.marker(e.latlng,{draggable:true}).addTo(map).bindPopup("مقصد").openPopup();}
});

function setCurrentLocation(){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const latlng=[pos.coords.latitude,pos.coords.longitude];
      if(originMarker){ originMarker.setLatLng(latlng); } 
      else { originMarker=L.marker(latlng,{draggable:true}).addTo(map).bindPopup("مبدا").openPopup(); }
      map.setView(latlng,14);
    });
  }else alert("امکان دریافت موقعیت وجود ندارد!");
}
function lockOrigin(){ if(originMarker){ originMarker.dragging.disable(); originMarker.bindPopup("مبدا (قفل)").openPopup(); } }
function unlockOrigin(){ if(originMarker){ originMarker.dragging.enable(); originMarker.bindPopup("مبدا").openPopup(); } }

/* socket.IO */
const socket = io("https://naji-backend.onrender.com");
let currentRequestId = null;
let liveInterval = null;

/* ارسال درخواست */
function requestService() {
  if (!originMarker || !destinationMarker){ alert("ابتدا مبدا و مقصد را تعیین کنید"); return; }
  const origin = originMarker.getLatLng();
  const dest = destinationMarker.getLatLng();
  const driverData = JSON.parse(localStorage.getItem("driverData")) || {};

  // نمایش پنل انتظار
  document.getElementById('waitingPanel').style.display='flex';

  socket.emit("requestService", {
    driverId: socket.id,
    origin,
    dest,
    driverInfo: { fullName: driverData.name||'', phone: driverData.phone||'', plate: driverData.plate||'', image: document.getElementById('photoPreview').src||null }
  });

  // شروع ارسال موقعیت زنده
  startLiveTracking();
}

/* Live Tracking */
function startLiveTracking(){
  if(navigator.geolocation){
    liveInterval = setInterval(()=>{
      navigator.geolocation.getCurrentPosition(pos=>{
        const latlng={lat:pos.coords.latitude,lng:pos.coords.longitude};
        socket.emit('driverLocation',{driverId:socket.id,lat:latlng.lat,lng:latlng.lng});
        if(!liveMarker){
          liveMarker=L.marker(latlng,{icon:L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png',iconSize:[30,30]})}).addTo(map).bindPopup("راننده");
        } else liveMarker.setLatLng(latlng);
      });
    },3000);
  }
}

/* دریافت قبول درخواست از یدک‌کش */
socket.on('requestUpdate', (data) => {
  if(data.status==='accepted'){
    currentRequestId = data.requestId;
    const tow = data.towInfo;

    // مخفی کردن پنل انتظار
    document.getElementById('waitingPanel').style.display='none';

    // نمایش پنل ماموریت
    document.getElementById('tripPanel').style.display='block';
    document.getElementById('infoTowName').innerText = "نام: " + tow.fullName;
    document.getElementById('infoTowPhone').innerText = "تلفن: " + tow.phone;
    document.getElementById('infoTowPlate').innerText = "پلاک: " + tow.plate;
  }
});

/* لغو و پایان ماموریت */
document.getElementById('btnCancelTrip').addEventListener('click',()=>{
  if(currentRequestId){
    socket.emit('cancelTrip',{requestId:currentRequestId});
    cleanupRequest();
  }
});
document.getElementById('btnEndTrip').addEventListener('click',()=>{
  if(currentRequestId){
    socket.emit('endTrip',{requestId:currentRequestId});
    cleanupRequest();
  }
});

function cleanupRequest(){
  currentRequestId=null;
  document.getElementById('tripPanel').style.display='none';
  document.getElementById('waitingPanel').style.display='none';
  if(liveInterval){ clearInterval(liveInterval); liveInterval=null; }
  if(liveMarker){ map.removeLayer(liveMarker); liveMarker=null; }
}
</script>
</body>
</html>
