<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø±Ø§Ù†Ù†Ø¯Ù‡|Ù†Ø§Ø¬ÛŒ Ø±Ø§Ù‡</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
/* Ù¾Ø§ÛŒÙ‡ Ù…Ø¯Ø±Ù† */
* { margin:0; padding:0; box-sizing:border-box; font-family:'Vazirmatn','Roboto',sans-serif; }
html, body { height:100%; width:100%; background:#f5f7fa; }

/* Map */
#mapContainer { height:100vh; width:100%; position:relative; }
#map { height:100%; width:100%; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.15); }

/* Slide Panel Right Ù…Ø¯Ø±Ù† */
#slidePanel {
  position:absolute;
  top:0; right:-340px; 
  width:320px; height:100%;
  background: linear-gradient(135deg, #1e3a8a, #2563eb);
  color:white;
  padding:25px 20px;
  transition: right 0.5s cubic-bezier(0.77,0,0.175,1);
  z-index:1000;
  overflow-y:auto;
  border-top-left-radius:20px;
  border-bottom-left-radius:20px;
  box-shadow: -6px 0 24px rgba(0,0,0,0.2);
}
#slidePanel.open { right:0; }

/* Panel Headings */
#slidePanel h2 {
  margin-bottom:20px;
  text-align:center;
  font-size:1.4rem;
  letter-spacing:1px;
  text-shadow: 1px 1px 6px rgba(0,0,0,0.3);
}
#slidePanel h3 {
  margin:15px 0 10px;
  font-size:1rem;
  border-bottom:1px solid rgba(255,255,255,0.3);
  padding-bottom:6px;
  letter-spacing:0.5px;
}

/* Inputs and Buttons */
#slidePanel input, #slidePanel select {
  width:100%;
  padding:12px 14px;
  margin-bottom:14px;
  border-radius:12px;
  border:1px solid #cbd5e1;
  font-size:1rem;
  transition: all 0.3s ease;
}
#slidePanel input:focus, #slidePanel select:focus { 
  outline:none; 
  border-color:#60a5fa; 
  box-shadow:0 0 10px rgba(96,165,250,0.4); 
}
#slidePanel button {
  width:100%;
  padding:12px;
  border:none;
  border-radius:14px;
  cursor:pointer;
  margin-top:10px;
  font-size:1rem;
  font-weight:600;
  transition: all 0.3s ease;
  box-shadow:0 4px 12px rgba(0,0,0,0.2);
}
#slidePanel button:hover {
  transform: translateY(-3px);
  box-shadow:0 8px 18px rgba(0,0,0,0.3);
}
.btn-primary { background:#3b82f6; color:white; }
.btn-primary:hover { background:#60a5fa; }
.btn-success { background:#10b981; color:white; }
.btn-success:hover { background:#059669; }
.btn-danger { background:#ef4444; color:white; }
.btn-danger:hover { background:#dc2626; }

/* Ø¹Ú©Ø³ Ø±Ø§Ù†Ù†Ø¯Ù‡ */
#photoPreview {
  width:100px;
  height:100px;
  border-radius:50%;
  object-fit:cover;
  margin:15px auto;
  display:block;
  border:3px solid white;
  box-shadow:0 4px 14px rgba(0,0,0,0.25);
  transition: transform 0.3s ease;
}
#photoPreview:hover { transform: scale(1.08); }

/* Ù„ÛŒØ³Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø§Ù†Ù†Ø¯Ù‡ */
ul#driverInfo {
  list-style:none;
  padding-left:0;
  margin-bottom:15px;
}
ul#driverInfo li {
  padding:8px 0;
  font-size:1rem;
  border-bottom:1px solid rgba(255,255,255,0.2);
  display:flex;
  justify-content:space-between;
  letter-spacing:0.5px;
}

/* Toggle Button */
#toggleBtn {
  position:absolute;
  top:18px;
  right:18px;
  background:#3b82f6;
  color:white;
  border:none;
  border-radius:50%;
  width:55px; height:55px;
  font-size:28px;
  cursor:pointer;
  z-index:1001;
  display:flex;
  justify-content:center;
  align-items:center;
  box-shadow:0 6px 20px rgba(0,0,0,0.35);
  transition: transform 0.3s ease, background 0.3s ease;
}
#toggleBtn:hover { transform: scale(1.15); background:#60a5fa; }

/* Ù¾Ù†Ù„ Ø§Ù†ØªØ¸Ø§Ø± Ù…Ø¯Ø±Ù† */
#waitingPanel {
  display: none; 
  position: fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: linear-gradient(120deg,#0f2027,#203a43,#2c5364);
  background-size: 400% 400%;
  animation: gradientBG 25s ease infinite;
  color:#fff;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index:2000;
  text-align:center;
  backdrop-filter: blur(12px);
}
#waitingPanel .spinner {
  width:90px; height:90px;
  border:12px solid rgba(255,255,255,0.15);
  border-top:12px solid #00ffd5;
  border-radius:50%;
  animation: spin 1s linear infinite;
  margin-bottom:25px;
  box-shadow:0 0 30px rgba(0,255,213,0.6);
}
#waitingPanel #waitingText {
  font-size:1.6rem;
  font-weight:500;
  text-shadow:2px 2px 10px rgba(0,0,0,0.5);
  margin-bottom:25px;
}
#waitingPanel #cancelButton {
  position:relative;
  padding:16px 36px;
  font-size:1.2rem;
  font-weight:600;
  color:#00ffd5;
  background:#0f2027;
  border:2px solid #00ffd5;
  border-radius:50px;
  cursor:pointer;
  overflow:hidden;
  box-shadow:0 0 30px rgba(0,255,213,0.6);
  transition: all 0.3s ease;
}
#waitingPanel #cancelButton:hover {
  box-shadow:0 0 45px rgba(0,255,213,0.9);
  transform: translateY(-3px);
}
#waitingPanel .car-glow {
  content:'';
  position:absolute;
  top:50%; left:50%;
  width:100%; height:100%;
  background: radial-gradient(circle, rgba(0,255,213,0.5) 0%, transparent 70%);
  border-radius:50px;
  transform: translate(-50%,-50%) scale(1);
  animation: pulse 1.5s infinite;
  pointer-events:none;
}
#waitingPanel .particle {
  position:absolute;
  width:6px; height:6px;
  background: rgba(255,255,255,0.35);
  border-radius:50%;
  animation: float 7-9s ease-in-out infinite;
  filter:blur(1px);
  opacity:0.75;
}

/* Ø§Ù†ÛŒÙ…ÛŒØ´Ù†â€ŒÙ‡Ø§ */
@keyframes spin { 0%{transform:rotate(0deg);}100%{transform:rotate(360deg);} }
@keyframes pulse { 0%,100%{transform:translate(-50%,-50%) scale(1);}50%{transform:translate(-50%,-50%) scale(1.25);} }
@keyframes float {
  0%{transform:translateY(0) translateX(0) rotate(0deg);}
  25%{transform:translateY(-80px) translateX(25px) rotate(45deg);}
  50%{transform:translateY(-160px) translateX(-25px) rotate(90deg);}
  75%{transform:translateY(-240px) translateX(30px) rotate(135deg);}
  100%{transform:translateY(-320px) translateX(0px) rotate(180deg);}
}
@keyframes gradientBG {
  0% {background-position:0% 50%;}
  50% {background-position:100% 50%;}
  100% {background-position:0% 50%;}
}

/* Ù¾Ù†Ù„ Ù¾Ø§ÛŒÛŒÙ† Ù…Ø§Ù…ÙˆØ±ÛŒØª */
#tripPanel {
  display:none;
  position:fixed;
  bottom:0; left:0; right:0;
  background:#fff;
  border-top-left-radius:24px;
  border-top-right-radius:24px;
  border-top:4px solid #2563eb;
  padding:22px;
  z-index:1001;
  box-shadow:0 -6px 24px rgba(0,0,0,0.25);
  animation: slideUp 0.5s cubic-bezier(0.77,0,0.175,1);
}
@keyframes slideUp { from{transform:translateY(100%);opacity:0;} to{transform:translateY(0);opacity:1;} }

.trip-header h3 { font-size:1.3rem; color:#2563eb; text-align:center; margin:0; }
.trip-content { padding:12px 0; }
.trip-info p { margin:6px 0; font-size:1rem; color:#333; display:flex; justify-content:space-between; }
.trip-actions { display:flex; gap:12px; margin-top:20px; }
.btn { flex:1; padding:14px; border-radius:14px; font-size:1rem; cursor:pointer; transition:all 0.3s ease; }
.btn-cancel { background:#ef4444; color:#fff; }
.btn-cancel:hover { background:#dc2626; }
.btn-end { background:#10b981; color:#fff; }
.btn-end:hover { background:#059669; }

/* responsive Ù…ÙˆØ¨Ø§ÛŒÙ„ */
@media (max-width:768px){
  #slidePanel{ width:280px; right:-300px; padding:18px;}
  #slidePanel h2{ font-size:1.2rem; }
  #slidePanel h3{ font-size:0.95rem; }
  #slidePanel input,#slidePanel select,#slidePanel button{ font-size:0.95rem;}
  #photoPreview{ width:80px; height:80px; }
}
</style>

</head>
<body>

<div id="mapContainer">
  <div id="map"></div>

  <!-- Toggle Button -->
  <button id="toggleBtn" onclick="togglePanel()">â˜°</button>

  <!-- Slide Panel -->
  <div id="slidePanel">
    <h2>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø±Ø§Ù†Ù†Ø¯Ù‡</h2>

    <!-- Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø§Ù†Ù†Ø¯Ù‡ -->
    <ul id="driverInfo"></ul>

    <!-- Ø¢Ù¾Ù„ÙˆØ¯ Ø¹Ú©Ø³ -->
    <div>
      <h3>Ø¢Ù¾Ù„ÙˆØ¯ Ø¹Ú©Ø³</h3>
      <img id="photoPreview" src="" alt=" Ø¹Ú©Ø³">
      <input type="file" id="photoInput" onchange="previewPhoto(event)">
    </div>

    <!-- Ù†Ø¸Ø± Ø³Ù†Ø¬ÙŠ -->
    <div>
      <h3>Ù†Ø¸Ø± Ø³Ù†Ø¬ÙŠ Ø±Ø§Ù†Ù†Ø¯Ù‡</h3>
      <select id="surveyRating">
        <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÙŠØ¯</option>
        <option value="1">1 - Ø®ÙŠÙ„ÙŠ Ø¨Ø¯</option>
        <option value="2">2 - Ø¨Ø¯</option>
        <option value="3">3 - Ù…ØªÙˆØ³Ø·</option>
        <option value="4">4 - Ø®ÙˆØ¨</option>
        <option value="5">5 - Ø¹Ø§Ù„ÙŠ</option>
      </select>
      <button class="btn-primary" onclick="submitSurvey()">Ø§Ø±Ø³Ø§Ù„</button>
    </div>
<hr>
 <select id="towCity">
      <option value="bandar">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ù†Ø·Ù‚Ù‡</option>
      <option value="bandar">Ø¨Ù†Ø¯Ø±Ø§Ù…Ø§Ù… Ø®Ù…ÛŒÙ†ÛŒ (Ø±Ù‡)</option>
    </select>

    <!-- ÙØ±Ù… Ø«Ø¨Øª Ù†Ø§Ù… -->
    <div>
      <h3>Ø«Ø¨Øª Ù†Ø§Ù…</h3>
      <input type="text" id="name" placeholder="Ù†Ø§Ù… ÙˆÙ†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ">
      <input type="text" id="phone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³">
      <input type="text" id="carName" placeholder="Ù†Ø§Ù… Ø®ÙˆØ¯Ø±Ùˆ">
      <input type="text" id="plate" placeholder="Ù¾Ù„Ø§Ú© Ø®ÙˆØ¯Ø±Ùˆ">
      <input type="text" id="carColor" placeholder="Ø±Ù†Ú¯ Ø®ÙˆØ¯Ø±Ùˆ">
      <button class="btn-success" onclick="register()">Ø«Ø¨Øª Ù†Ø§Ù…</button>
    </div>
    <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÙŠ Ù†Ù‚Ø´Ù‡ -->
    <div style="margin-top:10px;">
      <button class="btn-success" onclick="setCurrentLocation()">Ù…ÙˆÙ‚Ø¹ÙŠØª Ù…Ù†</button>
      <button class="btn-primary" onclick="lockOrigin()">Ù‚ÙÙ„ Ù…Ø¨Ø¯Ø§</button>
      <button class="btn-danger" onclick="unlockOrigin()">Ø¢Ø²Ø§Ø¯Ø³Ø§Ø²ÙŠ Ù…Ø¨Ø¯Ø§</button>
      <button class="btn-primary" onclick="requestService()">Ø¯Ø±Ø®ÙˆØ§Ø³Øª</button>

    </div>

    <!-- Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø³ÙŠØ± -->
    <div style="margin-top:10px; background:white; color:black; padding:10px; border-radius:8px;">
      <strong>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø³ÙŠØ±:</strong>
      <p id="distance">ÙØ§ØµÙ„Ù‡: -</p>
      <p id="duration">Ø²Ù…Ø§Ù† ØªÙ‚Ø±ÙŠØ¨ÙŠ: -</p>
    </div>
  </div>
</div>
<!-- Ø¹Ù„Ø±Øª-->
 <!-- Modal Ù¾ÛŒØ´Ø±ÙØªÙ‡ -->
  <!-- ğŸŒˆ Ù…ÙˆØ¯Ø§Ù„ Ù‡Ø´Ø¯Ø§Ø± Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ -->
<div id="modernAlert" class="modal">
  <div class="modal-content">
    <div class="icon-wrap">
      <div class="icon-glow"></div>
      <svg viewBox="0 0 24 24" width="42" height="42" fill="none" stroke="white" stroke-width="2.5">
        <path id="iconPath" stroke-linecap="round" stroke-linejoin="round" />
      </svg>
    </div>
    <h3 id="modalTitle"><span style="font-size:80px;">âœ…</span><br>ÙˆØ±ÙˆØ¯ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯</h3>
    <p id="modalMessage">Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯  Ø®ÙˆØ¯ØªÙˆÙ† Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯âœ…</p>
    <button class="closeBtn" onclick="closeModal()">Ø¨Ø§Ø´Ù‡</button>
  </div>
</div>

<!-- ğŸ”Š ØµØ¯Ø§Ù‡Ø§ -->
<audio id="sound-success" src="https://cdn.pixabay.com/audio/2022/03/15/audio_7b6b1f1a5f.mp3"></audio>
<audio id="sound-error" src="https://cdn.pixabay.com/audio/2022/03/15/audio_66bcb8e331.mp3"></audio>
<audio id="sound-warning" src="https://cdn.pixabay.com/audio/2022/03/15/audio_063f694232.mp3"></audio>

<style>
/* ===== Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ù…ÙˆØ¯Ø§Ù„ ===== */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.35);
  backdrop-filter: blur(10px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

/* ===== Ø¨Ø¯Ù†Ù‡ Ù…ÙˆØ¯Ø§Ù„ ===== */
.modal-content {
  background: rgba(255,255,255,0.12);
  border: 1px solid rgba(255,255,255,0.25);
  backdrop-filter: blur(30px) saturate(160%);
  border-radius: 24px;
  padding: 40px 30px;
  text-align: center;
  color: #fff;
  width: 90%;
  max-width: 420px;
  box-shadow:
    0 0 30px rgba(255,255,255,0.15),
    0 25px 45px rgba(0,0,0,0.5);
  transform: scale(0.85) translateY(-30px);
  opacity: 0;
  animation: modalIn 0.6s cubic-bezier(.18,.89,.32,1.28) forwards;
  transition: all 0.3s ease;
}

/* ===== Ø¢ÛŒÚ©ÙˆÙ† ===== */
.icon-wrap {
  position: relative;
  width: 90px; height: 90px;
  margin: 0 auto 20px auto;
  display: flex;
  justify-content: center;
  align-items: center;
  border-radius: 50%;
  overflow: hidden;
}
.icon-glow {
  position: absolute;
  inset: 0;
  border-radius: 50%;
  filter: blur(12px);
  animation: glowPulse 2s infinite ease-in-out;
}

/* ===== Ù…ØªÙ† ===== */
#modalTitle {
  font-size: 1.5rem;
  margin-bottom: 10px;
  font-weight: 600;
  text-shadow: 0 2px 12px rgba(255,255,255,0.4);
}
#modalMessage {
  font-size: 1.05rem;
  opacity: 0.9;
  line-height: 1.6;
  margin-bottom: 25px;
}

/* ===== Ø¯Ú©Ù…Ù‡ ===== */
.closeBtn {
  padding: 12px 32px;
  border: none;
  border-radius: 14px;
  font-weight: bold;
  font-size: 1rem;
  cursor: pointer;
  color: #fff;
  background: linear-gradient(135deg, #00c6ff, #0072ff);
  box-shadow: 0 10px 25px rgba(0,114,255,0.5);
  transition: all 0.35s ease;
}
.closeBtn:hover {
  transform: scale(1.08);
  box-shadow: 0 14px 35px rgba(0,114,255,0.6);
}

/* ===== Ø±Ù†Ú¯â€ŒÙ‡Ø§ ===== */
.modal-success .icon-wrap {
  background: radial-gradient(circle at top left, #22c55e, #16a34a);
}
.modal-success .icon-glow {
  background: radial-gradient(circle, #4ade80 0%, transparent 70%);
}

.modal-error .icon-wrap {
  background: radial-gradient(circle at top left, #ef4444, #b91c1c);
}
.modal-error .icon-glow {
  background: radial-gradient(circle, #f87171 0%, transparent 70%);
}

.modal-warning .icon-wrap {
  background: radial-gradient(circle at top left, #facc15, #ca8a04);
}
.modal-warning .icon-glow {
  background: radial-gradient(circle, #fde047 0%, transparent 70%);
}

/* ===== Ø§Ù†ÛŒÙ…ÛŒØ´Ù†â€ŒÙ‡Ø§ ===== */
@keyframes modalIn {
  to { transform: scale(1) translateY(0); opacity: 1; }
}
@keyframes modalOut {
  to { transform: scale(0.85) translateY(-30px); opacity: 0; }
}
@keyframes glowPulse {
  0%,100% { opacity: 0.4; transform: scale(1); }
  50% { opacity: 0.9; transform: scale(1.15); }
}
</style>

<script>
let alertTimeout;
const iconPaths = {
  success: "M5 13l4 4L19 7",       // âœ“
  error: "M6 6l12 12M6 18L18 6",  // âœ•
  warning: "M12 8v4m0 4h.01"       // âš 
};

function showAlert(message, type="success") {
  const modal = document.getElementById('modernAlert');
  const content = modal.querySelector('.modal-content');
  const path = document.getElementById('iconPath');
  const title = document.getElementById('modalTitle');
  const msg = document.getElementById('modalMessage');

  // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
  content.classList.remove("modal-success","modal-error","modal-warning");
  content.classList.add("modal-"+type);

  // ØªÙ†Ø¸ÛŒÙ… Ø¢ÛŒÚ©ÙˆÙ† Ùˆ Ø¹Ù†ÙˆØ§Ù†
  path.setAttribute("d", iconPaths[type] || iconPaths.success);
  title.textContent =
    type === "success" ? "Ø¹Ù…Ù„ÛŒØ§Øª Ù…ÙˆÙÙ‚!" :
    type === "error" ? "Ø®Ø·Ø§ Ø±Ø® Ø¯Ø§Ø¯!" :
    "Ù‡Ø´Ø¯Ø§Ø±!";

  msg.textContent = message;

  // Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¯Ø§Ù„
  modal.style.display = 'flex';
  content.style.animation = 'modalIn 0.6s forwards';

  // Ù¾Ø®Ø´ ØµØ¯Ø§
  const audio = document.getElementById(`sound-${type}`);
  if (audio) {
    audio.currentTime = 0;
    audio.play().catch(()=>{});
  }

  // Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† Ø®ÙˆØ¯Ú©Ø§Ø±
  clearTimeout(alertTimeout);
  alertTimeout = setTimeout(closeModal, 3500);
}

function closeModal() {
  const modal = document.getElementById('modernAlert');
  const content = modal.querySelector('.modal-content');
  content.style.animation = 'modalOut 0.5s forwards';
  setTimeout(() => { modal.style.display = 'none'; }, 450);
  clearTimeout(alertTimeout);
}
</script>


<!-- Ù¾Ù†Ù„ Ø§Ù†ØªØ¸Ø§Ø± -->
 <!-- Ù¾Ù†Ù„ Ø§Ù†ØªØ¸Ø§Ø± -->
<div id="waitingPanel">
  <div class="spinner"></div>
  <div id="waitingText">
    Ù…Ø§ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ø±Ø§ Ø¨Ù‡ ÛŒØ¯Ú©Ø´â€ŒÙ‡Ø§ÛŒ Ø§Ø·Ø±Ø§Ù ÙØ±Ø³ØªØ§Ø¯ÛŒÙ…<br>
    Ù„Ø·ÙØ§ Ù…Ù†ØªØ¸Ø± Ù¾Ø°ÛŒØ±Ø´ ØªÙˆØ³Ø· ÛŒØ¯Ú©Ø´Ø§Ù† Ø¨Ø§Ø´ÛŒØ¯...
  </div>
  <button id="cancelButton">
    Ù„ØºÙˆ Ø¯Ø±Ø®ÙˆØ§Ø³Øª
    <span class="car-glow"></span>
  </button>
  
  <!-- Ø°Ø±Ø§Øª Ù†ÙˆØ±Ø§Ù†ÛŒ -->
  <div class="particle" style="top:50%; left:20%;"></div>
  <div class="particle" style="top:80%; left:70%;"></div>
  <div class="particle" style="top:90%; left:10%; animation-duration:8s;"></div>
  <div class="particle" style="top:85%; left:40%; animation-duration:7s;"></div>
</div>

<style>
  #waitingPanel {
    display: none; /* âš¡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ù…Ø®ÙÛŒ */
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: linear-gradient(120deg, #0f2027, #203a43, #2c5364);
    background-size: 400% 400%;
    animation: gradientBG 20s ease infinite;
    color: #fff;
    display:none; /* âš¡ ÙÙ‚Ø· ÙˆÙ‚ØªÛŒ JS Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ */
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    text-align: center;
    backdrop-filter: blur(10px);
  }

  @keyframes gradientBG {
    0% {background-position:0% 50%;}
    50% {background-position:100% 50%;}
    100% {background-position:0% 50%;}
  }

  .spinner {
    width: 80px;
    height: 80px;
    border: 10px solid rgba(255,255,255,0.15);
    border-top: 10px solid #00ffd5;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 25px auto;
    box-shadow: 0 0 20px rgba(0, 255, 213, 0.6);
  }

  @keyframes spin { 
    0% {transform: rotate(0deg);} 
    100% {transform: rotate(360deg);} 
  }

  #waitingText {
    font-size: 1.5rem;
    font-weight: 500;
    line-height: 1.5;
    text-shadow: 2px 2px 8px rgba(0,0,0,0.5);
    letter-spacing: 1px;
    margin-bottom: 20px;
  }

  #cancelButton {
    position: relative;
    padding: 14px 32px;
    font-size: 1.1rem;
    font-weight: 600;
    color: #00ffd5;
    background: #0f2027;
    border: 2px solid #00ffd5;
    border-radius: 50px;
    cursor: pointer;
    overflow: hidden;
    box-shadow: 0 0 20px rgba(0, 255, 213, 0.5);
    transition: all 0.3s ease;
  }

  #cancelButton:hover {
    box-shadow: 0 0 35px rgba(0, 255, 213, 0.9);
    transform: translateY(-3px);
  }

  .car-glow {
    content: '';
    position: absolute;
    top: 50%; left: 50%;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle, rgba(0,255,213,0.5) 0%, transparent 70%);
    border-radius: 50px;
    transform: translate(-50%, -50%) scale(1);
    animation: pulse 1.5s infinite;
    pointer-events: none;
  }

  @keyframes pulse {
    0% {transform: translate(-50%, -50%) scale(1);}
    50% {transform: translate(-50%, -50%) scale(1.2);}
    100% {transform: translate(-50%, -50%) scale(1);}
  }

  .particle {
    position: absolute;
    width: 6px;
    height: 6px;
    background: rgba(255,255,255,0.3);
    border-radius: 50%;
    animation: float 8s ease-in-out infinite;
    filter: blur(1px);
    opacity: 0.7;
  }

  @keyframes float {
    0% {transform: translateY(0) translateX(0) rotate(0deg);}
    25% {transform: translateY(-100px) translateX(30px) rotate(45deg);}
    50% {transform: translateY(-200px) translateX(-20px) rotate(90deg);}
    75% {transform: translateY(-300px) translateX(40px) rotate(135deg);}
    100% {transform: translateY(-400px) translateX(0px) rotate(180deg);}
  }
</style>

<script>
  // Ù†Ù…Ø§ÛŒØ´ Ù¾Ù†Ù„ ÙÙ‚Ø· Ù‡Ù†Ú¯Ø§Ù… Ø¯Ø±Ø®ÙˆØ§Ø³Øª
  function showWaitingPanel() {
    document.getElementById('waitingPanel').style.display = 'flex';
  }

  function hideWaitingPanel() {
    document.getElementById('waitingPanel').style.display = 'none';
  }

  document.getElementById("cancelButton").addEventListener("click", hideWaitingPanel);

  // Ù…Ø«Ø§Ù„ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯Ú©Ù…Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø³Ø±ÙˆÛŒØ³
  function requestService() {
    // Ù†Ù…Ø§ÛŒØ´ Ù¾Ù†Ù„ Ù‡Ù†Ú¯Ø§Ù… Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª
    showWaitingPanel();
    // Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ Ø³Ø±ÙˆØ± Ùˆ Ø¨Ù‚ÛŒÙ‡ Ú©Ø§Ø±Ù‡Ø§...
  }
</script>

<!-- Ù¾Ù†Ù„ Ù¾Ø§ÛŒÛŒÙ† Ø±Ø§Ù†Ù†Ø¯Ù‡ -->
<div id="tripPanel">
  <div class="trip-header">
    <h3>ğŸ“Œ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÛŒØ¯Ú©â€ŒÚ©Ø´</h3>
  </div>
  <div class="trip-content">
    <div class="trip-info">
      <p><strong>Ù†Ø§Ù…:</strong> <span id="infoTowName">-</span></p>
      <p><strong>ØªÙ„ÙÙ†:</strong> <span id="infoTowPhone">-</span></p>
      <p><strong>Ù¾Ù„Ø§Ú©:</strong> <span id="infoTowPlate">-</span></p>
      <p><strong>ÙØ§ØµÙ„Ù‡:</strong> <span id="towDistance">-</span></p>
      <p><strong>Ø²Ù…Ø§Ù† ØªÙ‚Ø±ÛŒØ¨ÛŒ:</strong> <span id="towDuration">-</span></p>
    </div>
  </div>
  <div class="trip-actions">
    <button id="btnCancelTrip" class="btn btn-cancel">Ù„ØºÙˆ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</button>
    <button id="btnEndTrip" class="btn btn-end">Ù¾Ø§ÛŒØ§Ù† Ù…Ø£Ù…ÙˆØ±ÛŒØª</button>
  </div>
</div>
<style>
  #tripPanel {
  display: none;
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: #fff;
  border-top-left-radius: 20px;
  border-top-right-radius: 20px;
  border-top: 3px solid #2563eb;
  padding: 20px;
  z-index: 1001;
  box-shadow: 0 -4px 20px rgba(0,0,0,0.25);
  font-family: "Vazirmatn", sans-serif;
  animation: slideUp 0.4s ease;
}

@keyframes slideUp {
  from { transform: translateY(100%); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.trip-header {
  text-align: center;
  margin-bottom: 15px;
}

.trip-header h3 {
  font-size: 1.3rem;
  color: #2563eb;
  margin: 0;
}

.trip-content {
  padding: 10px 0;
}

.trip-info p {
  margin: 6px 0;
  font-size: 1rem;
  color: #333;
}

.trip-info strong {
  color: #111;
}

.trip-actions {
  display: flex;
  justify-content: space-between;
  margin-top: 20px;
  gap: 10px;
}

.btn {
  flex: 1;
  padding: 12px;
  border: none;
  border-radius: 12px;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-cancel {
  background: #ef4444;
  color: #fff;
}

.btn-cancel:hover {
  background: #dc2626;
}

.btn-end {
  background: #10b981;
  color: #fff;
}

.btn-end:hover {
  background: #059669;
}

</style>
<script>
// Ú¯Ø±ÙØªÙ† Ø§Ø¬Ø§Ø²Ù‡ Ù¾Ø®Ø´ ØµØ¯Ø§ Ø¨Ø§ Ø§ÙˆÙ„ÛŒÙ† Ú©Ù„ÛŒÚ© ÛŒØ§ Ù„Ù…Ø³
document.addEventListener("click", enableAudio, { once: true });
document.addEventListener("touchstart", enableAudio, { once: true });

function enableAudio() {
  const sounds = [
    document.getElementById('sound-success'),
    document.getElementById('sound-error'),
    document.getElementById('sound-warning')
  ];
  sounds.forEach(audio => {
    if (audio) {
      audio.play().then(() => {
        audio.pause();
        audio.currentTime = 0;
      }).catch(()=>{});
    }
  });
  console.log("ğŸµ Ø§Ø¬Ø§Ø²Ù‡ Ù¾Ø®Ø´ ØµØ¯Ø§ ÙØ¹Ø§Ù„ Ø´Ø¯!");
}
</script>


<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<!-- socket.IO -->
 <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  
/* Map */
const map = L.map('map').setView([35.6895,51.3890],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);

/* Slide Panel */
function togglePanel(){ document.getElementById('slidePanel').classList.toggle('open'); }

/* Ø±Ø§Ù†Ù†Ø¯Ù‡ */
window.onload = function(){
  const driverData = localStorage.getItem("driverData");
  if(driverData){
    fillDashboard(JSON.parse(driverData));
  } else {
    showAlert("Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÙŠØ¯");
    window.location.href = "driver-login.html";
  }
}

function register(){
  const data={
    name:document.getElementById('name').value,
    phone:document.getElementById('phone').value,
    carName:document.getElementById('carName').value,
    plate: document.getElementById('plate').value,
    carColor:document.getElementById('carColor').value
  };
  localStorage.setItem("driverData",JSON.stringify(data));
  fillDashboard(data);
  showAlert("Ø«Ø¨Øª Ù†Ø§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÙŠØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!");
}

function fillDashboard(data){
  const list = document.getElementById('driverInfo');
  list.innerHTML = "";
  const items = [
    `Ù†Ø§Ù…: ${data.name}`,
    `Ø´Ù…Ø§Ø±Ù‡: ${data.phone}`,
    `Ø®ÙˆØ¯Ø±Ùˆ: ${data.carName}`,
     `Ø´Ù…Ø§Ø±Ù‡ Ù¾Ù„Ø§Ú© :${data.plate}`, 
    `Ø±Ù†Ú¯ Ø®ÙˆØ¯Ø±Ùˆ:${data.carColor}`
  ];
  items.forEach(text => {
    const li = document.createElement('li');
    li.innerHTML = text;
    list.appendChild(li);
  });
}

/* Ø¢Ù¾Ù„ÙˆØ¯ Ø¹Ú©Ø³ */
function previewPhoto(event){
  const reader=new FileReader();
  reader.onload=function(){document.getElementById('photoPreview').src=reader.result;}
  reader.readAsDataURL(event.target.files[0]);
}

/* Ù†Ø¸Ø± Ø³Ù†Ø¬ÙŠ */
function submitSurvey(){
  const rating=document.getElementById('surveyRating').value;
  if(!rating){ showAlert("Ù„Ø·ÙØ§ Ø§Ù…ØªÙŠØ§Ø² Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÙŠØ¯"); return; }
  alert("Ø¨Ø§ ØªØ´Ú©Ø± Ø§Ø² Ù†Ø¸Ø± Ø´Ù…Ø§: "+rating+"/5");
  document.getElementById('surveyRating').value = "";
}

/* Ù†Ù‚Ø´Ù‡ Ù…Ø¨Ø¯Ø§ Ùˆ Ù…Ù‚ØµØ¯ */
let originMarker=null, destinationMarker=null, routeLine=null, liveMarker=null;

map.on('click', function(e){
  if(!originMarker){
    originMarker=L.marker(e.latlng,{draggable:true}).addTo(map).bindPopup("Ù…Ø¨Ø¯Ø§").openPopup();
  } else if(!destinationMarker){
    destinationMarker=L.marker(e.latlng,{draggable:true}).addTo(map).bindPopup("Ù…Ù‚ØµØ¯").openPopup();
  } else {
    const choice = showAlert("Ú©Ø¯Ø§Ù… Ø±Ø§ Ù…ÛŒ Ø®ÙˆØ§Ù‡ÛŒØ¯ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯ØŸ OK = Ù…Ø¨Ø¯Ø§, Cancel = Ù…Ù‚ØµØ¯");
    if(choice){ originMarker.setLatLng(e.latlng).bindPopup("Ù…Ø¨Ø¯Ø§").openPopup(); }
    else { destinationMarker.setLatLng(e.latlng).bindPopup("Ù…Ù‚ØµØ¯").openPopup(); }
    if(routeLine) map.removeLayer(routeLine);
    if(liveMarker) map.removeLayer(liveMarker);
  }
});

function setCurrentLocation(){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const latlng=[pos.coords.latitude,pos.coords.longitude];
      if(originMarker){ originMarker.setLatLng(latlng); } 
      else { originMarker=L.marker(latlng,{draggable:true}).addTo(map).bindPopup("Ù…Ø¨Ø¯Ø§").openPopup(); }
      map.setView(latlng,14);
    });
  }else showAlert("Ø§Ù…Ú©Ø§Ù† Ø¯Ø±ÙŠØ§ÙØª Ù…ÙˆÙ‚Ø¹ÙŠØª ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!");
}

function lockOrigin(){ if(originMarker){ originMarker.dragging.disable(); originMarker.bindPopup("Ù…Ø¨Ø¯Ø§ (Ù‚ÙÙ„)").openPopup(); } }
function unlockOrigin(){ if(originMarker){ originMarker.dragging.enable(); originMarker.bindPopup("Ù…Ø¨Ø¯Ø§").openPopup(); } }


// socket.IO
let currentRequestId = null;
let towLiveMarker = null;
let towLiveInterval = null;
const socket = io("https://naji-backend.onrender.com");

//   alert('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ Ùˆ Ù…Ù†ØªØ¸Ø± Ù¾Ø§Ø³Ø® ÙŠØ¯Ú©â€ŒÚ©Ø´ Ù‡Ø³ØªÙŠØ¯...');
// }

// Ø¯Ø±ÙŠØ§ÙØª Ø¢Ù¾Ø¯ÙŠØª Ø§Ø² ÙŠØ¯Ú©â€ŒÚ©Ø´

// --- ÙˆÙ‚ØªÛŒ ÛŒØ¯Ú©â€ŒÚ©Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ùˆ Ù‚Ø¨ÙˆÙ„ Ú©Ø±Ø¯
socket.on('requestUpdate', (data) => {
  if(data.status === 'accepted'){
    currentRequestId = data.requestId;
    const tow = data.towInfo;

    document.getElementById('waitingPanel').style.display = 'none';
    document.getElementById('infoTowName').innerText = "Ù†Ø§Ù…: " + tow.fullName;
    document.getElementById('infoTowPhone').innerText = "ØªÙ„ÙÙ†: " + tow.phone;
    document.getElementById('infoTowPlate').innerText = "Ù¾Ù„Ø§Ú©: " + tow.plate;
    document.getElementById('tripPanel').style.display = 'block';

    stopTowLiveUpdates(); // Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯
    startTowLiveUpdates(data.requestId);
  }
});
  // variables
// ÙˆÙ‚ØªÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ùˆ Ù‚Ø¨ÙˆÙ„ Ú©Ø±Ø¯ÛŒ (ÛŒØ§ Ø¨Ù„Ø§ÙØ§ØµÙ„Ù‡ Ø¨Ø¹Ø¯ Ø§Ø² receiveRequest Ùˆ accept)
function startTowLiveUpdates(requestId) {
  if (!navigator.geolocation) return;
  // Ø§Ø±Ø³Ø§Ù„ Ø§ÙˆÙ„ÛŒÙ‡ Ù‡Ù… Ø®ÙˆØ¨Ù‡
  navigator.geolocation.getCurrentPosition(pos => {
    socket.emit('towLocation', { requestId, lat: pos.coords.latitude, lng: pos.coords.longitude });
  });
  // Ø³Ù¾Ø³ Ù‡Ø± 2-3 Ø«Ø§Ù†ÛŒÙ‡ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†
  towLiveInterval = setInterval(() => {
    navigator.geolocation.getCurrentPosition(pos => {
      socket.emit('towLocation', { requestId, lat: pos.coords.latitude, lng: pos.coords.longitude });
    }, err => {/* ignore */});
  }, 30000);
}

function stopTowLiveUpdates(){
  if (towLiveInterval) { clearInterval(towLiveInterval); towLiveInterval = null; }
}

// --- Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª Ø²Ù†Ø¯Ù‡ ÛŒØ¯Ú©â€ŒÚ©Ø´ Ùˆ Ø±Ø³Ù… Ù…Ø³ÛŒØ±
// Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù‡: Ø¨Ø¹Ø¯ Ø§Ø² requestUpdate listener
 // Ù…Ø§Ø±Ú©Ø± ÛŒØ¯Ú©â€ŒØ´Ú© Ú©Ù‡ Ø±Ø§Ù†Ù†Ø¯Ù‡ Ù…ÛŒâ€ŒØ¨ÛŒÙ†Ù‡

socket.on('towLocation', (data) => {
  // data: { requestId, lat, lng, towId? }
  if (!currentRequestId) return;
  if (data.requestId && data.requestId !== currentRequestId) return; // ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÙØ¹Ù„ÛŒ

  const latlng = [data.lat, data.lng];

  if (!towLiveMarker) {
    towLiveMarker = L.marker(latlng, {
      icon: L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
        iconSize: [36, 36],
        iconAnchor: [18, 36]
      })
    }).addTo(map).bindPopup("ÛŒØ¯Ú©â€ŒØ´Ú© Ø¯Ø± Ù…Ø³ÛŒØ±");
  } else {
    towLiveMarker.setLatLng(latlng);
  }
});

// --- Ù„ØºÙˆ Ø¯Ø±Ø®ÙˆØ§Ø³Øª
document.getElementById('btnCancelTrip').addEventListener('click', () => {
  if(currentRequestId){
    socket.emit('cancelTrip', { requestId: currentRequestId });
    document.getElementById('tripPanel').style.display = 'none';
    if(towRouteLine) map.removeLayer(towRouteLine);
  }
});

// --- Ù¾Ø§ÛŒØ§Ù† Ù…Ø£Ù…ÙˆØ±ÛŒØª
document.getElementById('btnEndTrip').addEventListener('click', () => {
  if(currentRequestId){
    socket.emit('endTrip', { requestId: currentRequestId });
    document.getElementById('tripPanel').style.display = 'none';
    if(towRouteLine) map.removeLayer(towRouteLine);
  }
});

// live marker
// Ø§Ø±Ø³Ø§Ù„ Ù…ÙˆÙ‚Ø¹ÙŠØª Ø±Ø§Ù†Ù†Ø¯Ù‡ Ù‡Ø± 3 Ø«Ø§Ù†ÙŠÙ‡
let liveInterval;



function startLiveTracking() {
  if(navigator.geolocation){
    liveInterval = setInterval(() => {
      navigator.geolocation.getCurrentPosition(pos => {
        const latlng = { lat: pos.coords.latitude, lng: pos.coords.longitude };

        // Ø§Ø±Ø³Ø§Ù„ Ù…ÙˆÙ‚Ø¹ÙŠØª Ø¨Ù‡ Ø³Ø±ÙˆØ±
        socket.emit('driverLocation', { driverId: socket.id, lat: latlng.lat, lng: latlng.lng });


        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÙŠ ÙŠØ§ Ø³Ø§Ø®Øª Ù…Ø§Ø±Ú©Ø± Ø±Ø§Ù†Ù†Ø¯Ù‡
        if(!liveMarker){
          liveMarker = L.marker(latlng, {
            icon: L.icon({
              iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
              iconSize: [30,30]
            })
          }).addTo(map).bindPopup("Ø±Ø§Ù†Ù†Ø¯Ù‡");
        } else {
          liveMarker.setLatLng(latlng);
        }
      });
    }, 3000); // Ù‡Ø± 3 Ø«Ø§Ù†ÙŠÙ‡
  } else {
    showAlert("Ø§Ù…Ú©Ø§Ù† Ø¯Ø±ÙŠØ§ÙØª Ù…ÙˆÙ‚Ø¹ÙŠØª ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!");
  }
}




// Ù‡Ù†Ú¯Ø§Ù… Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø³Ø±ÙˆÙŠØ³ Ø´Ø±ÙˆØ¹ Ù…ÙŠâ€ŒÚ©Ù†ÙŠÙ…
function requestService() {
  if (!originMarker || !destinationMarker) {
    showAlert("Ø§Ø¨ØªØ¯Ø§ Ù…Ø¨Ø¯Ø§ Ùˆ Ù…Ù‚ØµØ¯ Ø±Ø§ ØªØ¹ÛŒÛŒÙ† Ú©Ù†ÛŒØ¯");
    return;
  }

  const origin = originMarker.getLatLng();
  const dest = destinationMarker.getLatLng();
  const driverData = JSON.parse(localStorage.getItem("driverData")) || {};

  socket.emit("requestService", {
    driverId: socket.id,
    origin,
    dest,
    driverInfo: {
      fullName: driverData.name || '',
      phone: driverData.phone || '',
      plate: driverData.plate || '',
      image: document.getElementById('photoPreview').src || null
    }
  });

  // âœ… ÙÙ‚Ø· Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø¨Ø´Ù‡
  document.getElementById('waitingPanel').style.display = 'flex';

  startLiveTracking();
}



async function getRoute(origin, destination) {
  try {
    const url = `https://router.project-osrm.org/route/v1/driving/${origin.lng},${origin.lat};${destination.lng},${destination.lat}?overview=full&geometries=geojson`;
    
    const res = await fetch(url);
    const data = await res.json();

    if(data.routes && data.routes.length > 0){
      const route = data.routes[0];
      const coords = route.geometry.coordinates.map(c => [c[1], c[0]]);
      const distance = (route.distance / 1000).toFixed(2); // Ú©ÙŠÙ„ÙˆÙ…ØªØ±
      const duration = Math.ceil(route.duration / 60); // Ø¯Ù‚ÙŠÙ‚Ù‡

      if(routeLine) map.removeLayer(routeLine);
      routeLine = L.polyline(coords, {color:'blue', weight:4}).addTo(map);
      map.fitBounds(routeLine.getBounds());

      document.getElementById('distance').innerText = `ÙØ§ØµÙ„Ù‡: ${distance} km`;
      document.getElementById('duration').innerText = `Ø²Ù…Ø§Ù† ØªÙ‚Ø±ÙŠØ¨ÙŠ: ${duration} Ø¯Ù‚ÙŠÙ‚Ù‡`;

      return { distance, duration };
    }
  } catch(err){
    console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÙŠØ§ÙØª Ù…Ø³ÙŠØ±:", err);
  }
}

let towRouteLine = null;

async function drawRouteToTow(driverLatLng, towLatLng) {
  try {
    const url = `https://router.project-osrm.org/route/v1/driving/${towLatLng.lng},${towLatLng.lat};${driverLatLng.lng},${driverLatLng.lat}?overview=full&geometries=geojson`;
    const res = await fetch(url);
    const data = await res.json();

    if(data.routes && data.routes.length > 0){
      const route = data.routes[0];
      const coords = route.geometry.coordinates.map(c => [c[1], c[0]]);
      const distance = (route.distance / 1000).toFixed(2);
      const duration = Math.ceil(route.duration / 60);

      if(towRouteLine) map.removeLayer(towRouteLine);
      towRouteLine = L.polyline(coords, {color:'red', weight:4}).addTo(map);
      map.fitBounds(towRouteLine.getBounds());

      document.getElementById('towDistance').innerText = `ÙØ§ØµÙ„Ù‡: ${distance} km`;
      document.getElementById('towDuration').innerText = `Ø²Ù…Ø§Ù† ØªÙ‚Ø±ÙŠØ¨ÙŠ: ${duration} Ø¯Ù‚ÙŠÙ‚Ù‡`;
    }
  } catch(err){
    console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÙŠØ§ÙØª Ù…Ø³ÙŠØ±:", err);
  }
}

function cleanupRequest() {
  currentRequestId = null;

  // Ø¨Ø³ØªÙ† Ù¾Ù†Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÛŒØ¯Ú©Ø´
  document.getElementById('tripPanel').style.display = 'none';

  // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù…Ø³ÛŒØ± ÛŒØ¯Ú©Ø´
  if (towRouteLine) {
    map.removeLayer(towRouteLine);
    towRouteLine = null;
  }
  
  // ØªÙˆÙ‚Ù Ø§Ø±Ø³Ø§Ù„ Ù„ÙˆÚ©ÛŒØ´Ù† Ø²Ù†Ø¯Ù‡ Ø±Ø§Ù†Ù†Ø¯Ù‡
  if (liveInterval) {
    clearInterval(liveInterval);
    liveInterval = null;
  }
  // Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø§Ú¯Ù‡ Ø®ÙˆØ§Ø³ØªÛŒ Ù…Ø³ÛŒØ± Ù…Ø¨Ø¯Ø§-Ù…Ù‚ØµØ¯ Ø±Ø§Ù†Ù†Ø¯Ù‡ Ø±Ùˆ Ù‡Ù… Ù¾Ø§Ú© Ú©Ù†ÛŒ
  // if (routeLine) { map.removeLayer(routeLine); routeLine = null; }
  if (towLiveMarker) { map.removeLayer(towLiveMarker); towLiveMarker = null; }

}

socket.on('tripEnded', (info) => {
  alert(info.message || "Ù…Ø§Ù…ÙˆØ±ÛŒØª Ù¾Ø§ÛŒØ§Ù† ÛŒØ§ÙØª ØªÙˆØ³Ø· ÛŒØ¯Ú©â€ŒÚ©Ø´");
  // Ø§ÛŒÙ†Ø¬Ø§ Ù‡Ø± UI Ú©Ù‡ Ø®ÙˆØ§Ø³ØªÛŒ ØªØºÛŒÛŒØ± Ø¨Ø¯Ù‡ØŒ Ù…Ø«Ù„Ø§Ù‹ Ù¾Ù†Ù„ Ù…Ø§Ù…ÙˆØ±ÛŒØª Ø±Ùˆ Ø¨Ø¨Ù†Ø¯
  cleanupRequest();
});

socket.on('tripCanceled', (info) => {
  alert(info.message || "Ù…Ø§Ù…ÙˆØ±ÛŒØª Ù„ØºÙˆ Ø´Ø¯ ØªÙˆØ³Ø· ÛŒØ¯Ú©â€ŒÚ©Ø´");
  cleanupRequest();
});


document.getElementById("cancelButton").addEventListener("click", function() {
    document.getElementById("waitingPanel").style.display = "none";
    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ø¯ Ù„ØºÙˆ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø³Ø±ÙˆØ± ÛŒØ§ Ø¹Ù…Ù„ÛŒØ§Øª Ø¯ÛŒÚ¯Ø±
});


</script>
</body>
</html>


